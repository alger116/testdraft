<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riigihanke Andmed</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/@heroicons/react/outline"></script>
    <script src="https://cdn.jsdelivr.net/npm/daisyui"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="config.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, setDoc, updateDoc, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        if (!window.FIREBASE_CONFIG) {
            console.error("‚ö† Firebase konfiguratsiooni ei leitud! Kontrolli, kas `config.js` on √µigesti laaditud.");
        } else {
            const app = initializeApp(window.FIREBASE_CONFIG);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Tee Firebase objektid globaalselt k√§ttesaadavaks
            window.auth = auth;
            window.db = db;
        }

        // ‚úÖ Lisa Firestore ja muud funktsioonid globaalseks
        window.auth = auth;
        window.db = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.arrayRemove = arrayRemove;

        function loadUserSearches() {
            console.log("üì• Laen kasutaja otsingud Firestore'ist...");
            // Firestore p√§ringud siia
        }
        window.loadUserSearches = loadUserSearches;

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Modern Navbar with Active Tab Highlighting -->
    <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 shadow-md w-full sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center relative">
            <!-- ‚úÖ Keskendatud sisselogimise teade -->
            <div id="loginNotification"
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hidden">
                ‚úÖ
            </div>
            <div id="notification"
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hidden">
                Andmete salvestamiseks peab olema sisse logitud!
            </div>

            <!-- ‚úÖ Title + Dropdown (Left Side) -->
            <div class="flex items-center space-x-4 relative">
                <h1 class="text-2xl font-bold">
                    <a href="index.html" class="hover:underline">Riigihanke andmed</a>
                </h1>
                <!-- ‚úÖ Dropdown Button (Aligned Right, Opens Down) -->
                <div class="relative">
                    <button id="dropdownButton" class="btn btn-primary" aria-label="Open Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>

                    <!-- ‚úÖ Dropdown Menu (Now Opens Down) -->
                    <div id="dropdownMenu"
                        class="hidden absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="dropdownButton">

                            <button id="showForm"
                                class="block px-4 py-2 text-sm text-gray-800 w-full text-left hover:bg-blue-600 hover:text-white transition transform hover:scale-105"
                                role="menuitem">
                                <i class="fas fa-tools mr-2"></i> T√∂√∂riist
                            </button>
                            <button id="showSavedSearches" class="block px-4 py-2 text-sm text-gray-800 hover:bg-blue-600 hover:text-white w-full text-left transition transform hover:scale-105 protected-section hidden
                                role=" menuitem">
                                <i class="fas fa-folder-open mr-2"></i> Hanked
                            </button>
                            <button id="settingsButton"
                                class="block px-4 py-2 text-sm text-gray-800 hover:bg-blue-600 hover:text-white w-full text-left transition transform hover:scale-105 protected-section hidden"
                                role="menuitem">
                                <i class="fas fa-cog mr-2"></i> Seaded
                            </button>
                            <a href="admin.html" id="adminTab" class="block px-4 py-2 text-sm text-gray-800 hover:bg-blue-600 hover:text-white w-full text-left transition transform hover:scale-105 protected-section hidden
                                role=" menuitem">
                                <i class="fas fa-user-shield mr-2"></i> Admin
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ Right Side (Login, Register, Logout, Dark Mode) -->
            <nav class="flex space-x-4 items-center">
                <div x-data="{ open: false }" class="relative">
                    <!-- ‚úÖ Login Button (Opens Modal) -->
                    <button id="loginButton" @click="open = true"
                        class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-1 rounded-lg flex items-center justify-center shadow-md hover:from-blue-600 hover:to-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
                    </button>

                    <!-- ‚úÖ Modal -->
                    <div x-show="open" x-cloak x-ref="loginModal"
                        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                        <div class="card w-96 bg-white shadow-xl p-8 rounded-xl border border-gray-200 relative">
                            <!-- ‚ùå Close Button -->
                            <button @click="open = false"
                                class="absolute top-2 right-2 text-gray-500 hover:text-red-500">
                                ‚úñ
                            </button>

                            <h2 class="text-3xl font-bold text-center text-gray-900 mb-4">Logi sisse</h2>

                            <!-- ‚úÖ Email Input -->
                            <div class="form-control w-full mb-3">
                                <label class="label text-gray-700 font-medium">E-post</label>
                                <input type="email" id="emailLogin" placeholder="Sisesta oma e-post"
                                    class="input input-bordered w-full text-gray-900 shadow-md rounded-lg p-3 focus:ring-2 focus:ring-blue-400 transition-all duration-300" />
                            </div>

                            <!-- ‚úÖ Password Input -->
                            <div class="form-control w-full mb-3">
                                <label class="label text-gray-700 font-medium">Parool</label>
                                <input type="password" id="passwordLogin" placeholder="Sisesta oma parool"
                                    class="input input-bordered w-full text-gray-900 shadow-md rounded-lg p-3 focus:ring-2 focus:ring-blue-400 transition-all duration-300" />
                            </div>

                            <!-- ‚úÖ Login Button -->
                            <button @click="login(); open = false"
                                class="btn btn-primary w-full mt-4 flex items-center justify-center transition-transform hover:scale-105 shadow-lg text-lg py-3 rounded-lg font-semibold bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white">
                                <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
                            </button>
                        </div>
                    </div>
                </div>



                <!-- ‚úÖ Firebase Login Script -->
                <script type="module">
                    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

                    window.login = async () => {
                        try {
                            const email = document.getElementById("emailLogin").value;
                            const password = document.getElementById("passwordLogin").value;
                            await signInWithEmailAndPassword(auth, email, password);

                            // ‚úÖ Kuvame teate
                            const notification = document.getElementById("loginNotification");
                            notification.classList.remove("hidden");

                            // ‚úÖ Sulgeme teate automaatselt 2 sekundi p√§rast
                            setTimeout(() => {
                                notification.classList.add("hidden");
                            }, 2000);

                            // ‚úÖ Sulgeme modaalakna Alpine.js kaudu
                            setTimeout(() => {
                                const modal = document.querySelector('[x-ref="loginModal"]');
                                if (modal && modal.__x) {
                                    modal.__x.$data.open = false;
                                }
                            }, 100);
                        } catch (error) {
                            alert("Sisselogimine eba√µnnestus: " + error.message);
                        }
                    };
                </script>

                <a href="register.html" id="registerButton"
                    class="save-button bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1 rounded-lg flex items-center justify-center shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-user-plus mr-2"></i> Registreeri
                </a>

                <button id="logoutButton"
                    class="btn bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1 rounded-lg flex items-center justify-center shadow-md hover:from-red-600 hover:to-red-700 hover:scale-105 hover:shadow-lg transition-all duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1m0-10V7m0 3V6m0 10v-3" />
                    </svg>
                    <span class="ml-2">Logi v√§lja</span>
                </button>


                <!-- ‚úÖ Dark Mode Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-200"></span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggleDarkMode" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 transition-all duration-300">
                        </div>
                        <div
                            class="w-5 h-5 bg-white rounded-full shadow-md absolute left-0.5 top-0.5 peer-checked:translate-x-full transition-transform duration-300">
                        </div>
                    </label>
                    <span class="text-sm text-gray-200"></span>
                </div>
            </nav>
        </div>
    </header>
    <main class="container mx-auto p-6 pt-32">
        </div>
        </div>
        <div id="toolTab" class="flex space-x-4">
            <div class="container bg-white p-6 rounded shadow max-w-2xl" id="formContainer">
                <h2 class="text-2xl font-bold text-center mb-4">Sisesta andmed</h2>
                <form id="procurementForm" class="space-y-4">
                    <div>
                        <label for="name" class="block text-gray-700 font-semibold mb-1">Riigihanke nimetus:</label>
                        <input type="text" id="name" name="name" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="cost" class="block text-gray-700 font-semibold mb-1">Riigihanke maksumus:</label>
                        <input type="number" id="cost" name="cost" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="procedureType" class="block text-gray-700 font-semibold mb-1">
                            Riigihanke menetlusliik:
                            <span id="procedureLabel"
                                class="text-gray-500 text-sm roboto opacity-0 transition-opacity duration-300 ml-1"></span>
                        </label>
                        <select id="procedureType" name="procedureType"
                            class="w-full p-2 border rounded bg-white shadow-sm text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required aria-label="Riigihanke menetlusliik">

                            <!-- Placeholder option (disabled & selected by default) -->
                            <option value="" disabled selected>Vali siit</option>
                            <optgroup label="Avatud hankemenetlus">
                                <option value="Avatud hankemenetlus asjade hankelepingu s√µlmimiseks">Asjade hankeleping
                                </option>
                                <option value="Avatud hankemenetlus teenuste hankelepingu s√µlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Avatud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks">Ehitust√∂√∂de
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Piiratud hankemenetlus">
                                <option value="Piiratud hankemenetlus asjade hankelepingu s√µlmimiseks">Asjade
                                    hankeleping</option>
                                <option value="Piiratud hankemenetlus teenuste hankelepingu s√µlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Piiratud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks">Ehitust√∂√∂de
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Konkurentsip√µhine l√§bir√§√§kimistega menetlus">
                                <option
                                    value="Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus asjade hankelepingu s√µlmimiseks">
                                    Asjade hankeleping</option>
                                <option
                                    value="Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus teenuste hankelepingu s√µlmimiseks">
                                    Teenuste hankeleping</option>
                                <option
                                    value="Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks">
                                    Ehitust√∂√∂de hankeleping</option>
                            </optgroup>

                            <optgroup label="V√µistlev dialoog">
                                <option value="V√µistlev dialoog asjade hankelepingu s√µlmimiseks">Asjade hankeleping
                                </option>
                                <option value="V√µistlev dialoog teenuste hankelepingu s√µlmimiseks">Teenuste hankeleping
                                </option>
                                <option value="V√µistlev dialoog ehitust√∂√∂de hankelepingu s√µlmimiseks">Ehitust√∂√∂de
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Innovatsioonipartnerlus">
                                <option value="Innovatsioonipartnerlus asjade hankelepingu s√µlmimiseks">Asjade
                                    hankeleping</option>
                                <option value="Innovatsioonipartnerlus teenuste hankelepingu s√µlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Innovatsioonipartnerlus ehitust√∂√∂de hankelepingu s√µlmimiseks">Ehitust√∂√∂de
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Kontsessioonimenetlus">
                                <option value="Kontsessioonimenetlus koos eraldi taotluse esitamisega">Koos eraldi
                                    taotlusega</option>
                                <option value="Kontsessioonimenetlus ilma eraldi taotlust esitamata">Ilma eraldi
                                    taotluseta</option>
                            </optgroup>

                            <optgroup label="Erimenetlused">
                                <option value="Sotsiaalteenuste erimenetlus">Sotsiaalteenuste erimenetlus</option>
                                <option value="Eriteenuste erimenetlus">Eriteenuste erimenetlus</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label for="contractSigningDate" class="block text-gray-700 font-semibold mb-1">Lepingu
                            allkirjastamise
                            kuup√§ev:</label>
                        <input type="date" id="contractSigningDate" name="contractSigningDate"
                            class="w-full p-2 border rounded" required>
                    </div>
                    <button type="submit"
                        class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg w-full flex items-center justify-center shadow-md hover:from-blue-600 hover:to-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-calculator mr-2"></i> Arvuta menetlusaeg
                    </button>
                    <button id="updateProcurement"
                        class="hidden bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition mt-4">
                        ‚úÖ Uuenda andmed
                    </button>
                </form>
            </div>
            <div class="container bg-white p-6 rounded shadow max-w-2xl hidden" id="resultContainer">
                <div id="result" class="result-card"></div>
            </div>
        </div>

        <!-- The saved searches container is hidden by default and will be shown when the user clicks the "Show Saved Searches" button -->
        <div class="container bg-white p-6 rounded-lg shadow-lg hidden" id="savedSearchesContainer">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">üìÅ Salvestatud Hanked</h2>
            <div class="overflow-x-auto bg-gray-100 p-4 rounded-lg shadow-md">
                <table class="w-full border-collapse shadow-lg rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-left">
                            <th class="p-4">üìå Nimi</th>
                            <th class="p-4">üìú Menetlusliik</th>
                            <th class="p-4">üí∞ Maksumus (‚Ç¨)</th>
                            <th class="p-4">üìÖ Taotluse Kuup√§ev</th>
                            <th class="p-4">üñäÔ∏è Allkirjastamise Kuup√§ev</th>
                            <th class="p-4 text-center">‚úèÔ∏è Muuda</th>
                            <th class="p-4 text-center">‚ùå Kustuta</th>
                        </tr>
                    </thead>
                    <tbody id="savedSearchesTableBody">
                        <!-- üî• Firestore data will be inserted here -->
                    </tbody>
                </table>
                </table>
                <div class="flex gap-4 mt-8 justify-center">
                    <button id="saveToExcel"
                        class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300"
                        aria-label="Save to Excel">
                        üìä Excel
                    </button>

                    <button id="hankeplaan"
                        class="flex items-center gap-2 bg-gradient-to-r from-yellow-400 to-yellow-500 text-black px-5 py-2 rounded-lg shadow-md hover:from-yellow-500 hover:to-yellow-600 hover:scale-105 transition-all duration-300"
                        aria-label="Generate Procurement Plan">
                        üìã Hankeplaan
                    </button>

                    <button id="showProgress"
                        class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-5 py-2 rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 hover:scale-105 transition-all duration-300"
                        aria-label="Show Progress">
                        üìà PDF
                    </button>
                </div>
            </div>

            <!-- Chart Container (Initially Hidden) -->
            <div id="chartContainer" class="hidden mt-4 w-full max-w-lg mx-auto">
                <canvas id="procurementChart" class="w-full"></canvas>
            </div>
        </div>
        <!-- Settings Container -->
        <div class="flex flex-wrap md:flex-nowrap gap-6 bg-white p-6 rounded-lg shadow-lg max-w-4xl hidden"
            id="settingsContainer" class="adminOnly hidden" aria-hidden="true"> <!-- Hidden by default -->

            <!-- Form Section -->
            <form id="settingsForm" class="flex-1 space-y-6 bg-gray-50 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800">üìë Menetlusliigi s√§tted</h3>

                <div class="relative">
                    <label for="documentPreparationDays" class="block text-gray-700 mb-1">üìÑ Riigihanke alusdokumentide
                        koostamine (p√§evad):</label>
                    <input type="number" id="documentPreparationDays" name="documentPreparationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta p√§evad" required>
                </div>

                <div class="relative">
                    <label for="offerEvaluationDays" class="block text-gray-700 mb-1">üßê Pakkumuste hindamine
                        (p√§evad):</label>
                    <input type="number" id="offerEvaluationDays" name="offerEvaluationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta p√§evad" required>
                </div>

                <div class="relative">
                    <label for="decisionDays" class="block text-gray-700 mb-1">‚úÖ Vastavaks ja edukaks tunnistamise otsus
                        (p√§evad):</label>
                    <input type="number" id="decisionDays" name="decisionDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta p√§evad" required>
                </div>

                <div class="relative">
                    <label for="bidderEvaluationDays" class="block text-gray-700 mb-1">üìä Pakkujate hindamine
                        (p√§evad):</label>
                    <input type="number" id="bidderEvaluationDays" name="bidderEvaluationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta p√§evad" required>
                </div>

                <div class="relative">
                    <label for="successfulBidderDays" class="block text-gray-700 mb-1">üèÜ Eduka k√µrvaldamata j√§tmine ja
                        kval (p√§evad):</label>
                    <input type="number" id="successfulBidderDays" name="successfulBidderDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta p√§evad" required>
                </div>

                <div class="relative">
                    <label for="waitingPeriodDays" class="block text-gray-700 mb-1">‚è≥ Ooteaeg (p√§evad):</label>
                    <input type="number" id="waitingPeriodDays" name="waitingPeriodDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta p√§evad" required>
                </div>

                <button type="submit"
                    class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 hover:scale-105 transition-all duration-300">
                    üíæ Salvesta
                </button>
            </form>

            <!-- Procedure Type Selection -->
            <div class="flex-1 bg-gray-50 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800 mb-3">üõ†Ô∏è Menetlusliigid</h3>
                <select id="procedureTypeSelect"
                    class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <!-- Options will be populated dynamically -->
                </select>
                <div id="procedureTypeSettings" class="mt-4 space-y-4">
                    <!-- Procedure type settings will be displayed here -->
                </div>
                <button id="addProcedureTypeButton"
                    class="w-full flex items-center justify-center gap-2 mt-4 bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300">
                    ‚ûï Lisa Menetlusliik
                </button>
            </div>
        </div>
        </div>
        </div>
        <div class="container bg-white p-6 rounded-lg shadow-lg hidden" id="historyContainer">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">üìú Arvutuste Ajalugu</h2>

            <!-- Filter Dropdown -->
            <div class="mb-4 bg-gray-100 p-4 rounded-lg shadow-md">
                <label for="filterByDate" class="block text-gray-700 font-semibold mb-2">üîé Filtreeri kuup√§eva
                    j√§rgi:</label>
                <select id="filterByDate"
                    class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">üìÖ K√µik kuup√§evad</option>
                    <!-- Options will be dynamically added here -->
                </select>
            </div>

            <div class="overflow-x-auto bg-gray-100 p-4 rounded-lg shadow-md">
                <table class="w-full border-collapse shadow-lg rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-left">
                            <th class="p-4">üìå Nimi</th>
                            <th class="p-4">üìú Menetlusliik</th>
                            <th class="p-4">üí∞ Maksumus (‚Ç¨)</th>
                            <th class="p-4">‚è≥ Menetlusaeg (p√§evad)</th>
                            <th class="p-4">üìÖ Taotluse Kuup√§ev</th>
                            <th class="p-4">üñäÔ∏è Allkirjastamise Kuup√§ev</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History entries will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modern Table -->
        <table id="recentCalculationsTable"
            class="w-full border-collapse shadow-lg rounded-lg overflow-hidden mt-4 hidden">
            <thead class="bg-blue-500 text-white">
                <tr>
                    <th class="p-3">Nimi</th>
                    <th class="p-3">Menetlusliik</th>
                    <th class="p-3">Maksumus</th>
                    <th class="p-3">Menetlusaeg</th>
                    <th class="p-3">Taotluse Kuup√§ev</th>
                </tr>
            </thead>
            <tbody id="recentCalculations">
                <!-- Last 3 calculations will be dynamically inserted here -->
            </tbody>
        </table>



        <!-- Notification System -->
        <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-md hidden">
            ‚úÖ !
        </div>

        <!-- ‚úÖ Kinnituse modal kustutamiseks -->
        <div id="deleteConfirmModal"
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg w-96 text-center">
                <h2 class="text-xl font-bold mb-4">Kas oled kindel?</h2>
                <p class="text-gray-600 mb-6">Soovid kindlasti kustutada selle riigihanke?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirmDelete"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Jah</button>
                    <button id="cancelDelete"
                        class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Ei</button>
                </div>
            </div>
        </div>
    </main>
    <script src="src/scripts/hanked.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>

        // kuup√§evade handl
        function formatDate(date) {
            if (!date) {
                console.error("‚ùå Received empty or invalid date:", date);
                return "M√§√§ramata"; // Kasutajas√µbralikum v√§ljund
            }

            // üîπ Kui `date` on juba Date objekt, tagasta √µiges formaadis
            if (date instanceof Date && !isNaN(date)) {
                return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
            }

            // üîπ Kui `date` on string formaadis "YYYY-MM-DD", teisenda see √µigeks
            if (typeof date === "string" && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [year, month, day] = date.split("-");
                return `${day}.${month}.${year}`;
            }

            // üîπ Kui `date` on string formaadis "dd.mm.yyyy", tagasta see muutmata kujul
            if (typeof date === "string" && date.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                return date;
            }

            // üîπ Kui `date` on Firestore timestamp, teisenda see √µigeks
            if (typeof date === "object" && date.toDate) {
                date = date.toDate();
            }

            // üîπ L√µplik kontroll, kas `date` on korrektne
            const parsedDate = new Date(date);
            if (isNaN(parsedDate.getTime())) {
                console.error("‚ùå Invalid date after parsing:", date);
                return "M√§√§ramata";
            }

            return `${String(parsedDate.getDate()).padStart(2, '0')}.${String(parsedDate.getMonth() + 1).padStart(2, '0')}.${parsedDate.getFullYear()}`;
        }

        const procedureData = {
            "Lihthankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 30000 },
            "Lihthankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 30000 },
            "Lihthankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Avatud hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Avatud hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Avatud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 25, piirm√§√§r: 150000 },
            "Piiratud hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Piiratud hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Piiratud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirm√§√§r: 150000 },
            "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirm√§√§r: 150000 },
            "Innovatsioonipartnerlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "Innovatsioonipartnerlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "V√µistlev dialoog asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "V√µistlev dialoog teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirm√§√§r: 60000 },
            "V√µistlev dialoog ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirm√§√§r: 150000 },
            "Innovatsioonipartnerlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirm√§√§r: 150000 },
            "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirm√§√§r: 300000 },
            "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirm√§√§r: 300000 },
            "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 300000 },
            "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 60000 },
        };

        const internationalProcedureData = {
            "Avatud hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirm√§√§r: 143000 },
            "Avatud hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirm√§√§r: 143000 },
            "Avatud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 45, piirm√§√§r: 5538000 },
            "Piiratud hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "Piiratud hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "Piiratud hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000 },
            "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "Konkurentsip√µhine l√§bir√§√§kimistega hankemenetlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000 },
            "Innovatsioonipartnerlus asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "Innovatsioonipartnerlus teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "Innovatsioonipartnerlus ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000 },
            "V√µistlev dialoog asjade hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "V√µistlev dialoog teenuste hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 143000 },
            "V√µistlev dialoog ehitust√∂√∂de hankelepingu s√µlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirm√§√§r: 5538000 },
            "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirm√§√§r: 5538000 },
            "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirm√§√§r: 5538000 },
            "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 750000 },
            "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirm√§√§r: 750000 }
        };

        const defaultSettings = {
            documentPreparationDays: 10,
            offerEvaluationDays: 5,
            decisionDays: 3,
            bidderEvaluationDays: 3,
            successfulBidderDays: 3,
            waitingPeriodDays: 14
        };

        let settings = { ...defaultSettings };

        const correctPassword = '123';
        let passwordValidUntil = null;

        function showPasswordPrompt(callback) {
            const now = new Date();
            if (passwordValidUntil && now < passwordValidUntil) {
                callback();
                return;
            }

            const passwordPrompt = document.getElementById('passwordPrompt');
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            passwordPrompt.classList.remove('hidden');
            passwordInput.value = '';
            passwordError.classList.add('hidden');

            document.getElementById('passwordSubmit').onclick = function () {
                if (passwordInput.value === correctPassword) {
                    passwordPrompt.classList.add('hidden');
                    passwordValidUntil = new Date(now.getTime() + 10 * 60000); // 10 minutes from now
                    callback();
                } else {
                    passwordError.classList.remove('hidden');
                }
            };

            document.getElementById('passwordClose').onclick = function () {
                passwordPrompt.classList.add('hidden');
            };
        }

        document.getElementById('settingsButton').addEventListener('click', function () {
            closeAllTabs();
            document.getElementById('settingsContainer').classList.remove('hidden');
            loadSettings();
            loadProcedureTypes();
            setActiveTab(this);
        });

        document.getElementById("adminTab").addEventListener("click", () => {
            window.location.href = "/admin.html"; // Redirect to the admin page
        });

        document.getElementById('settingsForm').addEventListener('submit', function (event) {
            event.preventDefault();
            settings.documentPreparationDays = parseInt(document.getElementById('documentPreparationDays').value);
            settings.offerEvaluationDays = parseInt(document.getElementById('offerEvaluationDays').value);
            settings.decisionDays = parseInt(document.getElementById('decisionDays').value);
            settings.bidderEvaluationDays = parseInt(document.getElementById('bidderEvaluationDays').value);
            settings.successfulBidderDays = parseInt(document.getElementById('successfulBidderDays').value);
            settings.waitingPeriodDays = parseInt(document.getElementById('waitingPeriodDays').value);
        });

        document.getElementById('addProcedureTypeButton').addEventListener('click', function () {
            addProcedureType();
        });

        document.getElementById('procedureTypeSelect').addEventListener('change', function () {
            const selectedType = this.value;
            loadProcedureTypeSettings(selectedType);
        });

        function loadSettings() {
            document.getElementById('documentPreparationDays').value = settings.documentPreparationDays;
            document.getElementById('offerEvaluationDays').value = settings.offerEvaluationDays;
            document.getElementById('decisionDays').value = settings.decisionDays;
            document.getElementById('bidderEvaluationDays').value = settings.bidderEvaluationDays;
            document.getElementById('successfulBidderDays').value = settings.successfulBidderDays;
            document.getElementById('waitingPeriodDays').value = settings.waitingPeriodDays;
        }

        function saveSettings() {
            localStorage.setItem('procurementSettings', JSON.stringify(settings));
        }

        function loadSavedSettings() {
            const savedSettings = localStorage.getItem('procurementSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
        }

        function loadProcedureTypes() {
            const select = document.getElementById('procedureTypeSelect');
            select.innerHTML = '';
            Object.keys(procedureData).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
            if (select.options.length > 0) {
                loadProcedureTypeSettings(select.options[0].value);
            }
        }

        function loadProcedureTypeSettings(type) {
            const procedure = procedureData[type];
            const container = document.getElementById('procedureTypeSettings');
            container.innerHTML = `
            <div class="procedure-type">
                <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                <input type="text" id="procedureTypeName" value="${type}" required><br><br>
                <label for="requestDays" class="block text-gray-700">Taotluste esitamise p√§evad:</label>
                <input type="number" id="requestDays" value="${procedure.taotlusteAeg}" required><br><br>
                <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise p√§evad:</label>
                <input type="number" id="offerDays" value="${procedure.pakkumusteAeg}" required><br><br>
                <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi t√§htaegu:</label>
                <input type="checkbox" id="useInternationalThreshold" ${procedure.useInternational ? 'checked' : ''} onchange="toggleInternationalThreshold('${type}')"><br><br>
                <button onclick="deleteProcedureType('${type}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition transform hover:scale-105">Kustuta</button>
                <button onclick="saveProcedureType('${type}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
            </div>
            `;
        }

        function addProcedureType() {
            const container = document.getElementById('procedureTypeSettings');
            container.innerHTML = `
            <div class="procedure-type">
                <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                <input type="text" id="procedureTypeName" required><br><br>
                <label for="requestDays" class="block text-gray-700">Taotluste esitamise p√§evad:</label>
                <input type="number" id="requestDays" required><br><br>
                <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise p√§evad:</label>
                <input type="number" id="offerDays" required><br><br>
                <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi t√§htaegu:</label>
                <input type="checkbox" id="useInternationalThreshold" onchange="toggleInternationalThreshold()"><br><br>
                <button onclick="saveNewProcedureType()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
            </div>
            `;
        }

        function toggleInternationalThreshold(type) {
            const useInternational = document.getElementById('useInternationalThreshold').checked;
            const procedure = useInternational ? internationalProcedureData[type] : procedureData[type];
            document.getElementById('requestDays').value = procedure.taotlusteAeg;
            document.getElementById('offerDays').value = procedure.pakkumusteAeg;
        }

        function deleteProcedureType(type) {
            delete procedureData[type];
            loadProcedureTypes();
            saveSettings();
        }

        function saveProcedureType(oldType) {
            const newType = document.getElementById('procedureTypeName').value;
            const requestDays = parseInt(document.getElementById('requestDays').value);
            const offerDays = parseInt(document.getElementById('offerDays').value);
            const useInternational = document.getElementById('useInternationalThreshold').checked;
            delete procedureData[oldType];
            procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirm√§√§r: 60000, useInternational }; // Default piirm√§√§r
            loadProcedureTypes();
            saveSettings();
        }

        function saveNewProcedureType() {
            const newType = document.getElementById('procedureTypeName').value;
            const requestDays = parseInt(document.getElementById('requestDays').value);
            const offerDays = parseInt(document.getElementById('offerDays').value);
            const useInternational = document.getElementById('useInternationalThreshold').checked;
            procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirm√§√§r: 60000, useInternational }; // Default piirm√§√§r
            loadProcedureTypes();
            saveSettings();
        }

        loadSavedSettings();

        class PublicProcurement {
            constructor(name, cost, procedureType, contractSigningDate) {
                // Ensure the date is valid before any conversion logic
                if (!contractSigningDate || isNaN(new Date(contractSigningDate).getTime())) {
                    console.error("Invalid contract signing date:", contractSigningDate);
                    this.contractSigningDate = null; // Avoid breaking further calculations
                } else {
                    // Convert dd.mm.yyyy to YYYY-MM-DD if necessary
                    if (typeof contractSigningDate === "string" && contractSigningDate.includes(".")) {
                        const parts = contractSigningDate.split(".");
                        if (parts.length === 3) {
                            contractSigningDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }
                    }
                    this.contractSigningDate = new Date(contractSigningDate);
                }

                this.name = name;
                this.cost = cost;
                this.procedureType = procedureType;
                this.contractSigningDate = new Date(contractSigningDate); null;
                this.procedureDuration = this.calculateProcedureDuration();
                this.procedureDetails = this.calculateProcedureDetails();
                this.requestSubmissionDate = this.calculateRequestSubmissionDate();
            }

            calculateProcedureDuration() {
                const procedure = procedureData[this.procedureType];
                const internationalProcedure = internationalProcedureData[this.procedureType];
                const internationalThreshold = internationalProcedure.piirm√§√§r;

                let duration = 0;

                if (this.cost > internationalThreshold || procedure.useInternational) {
                    duration += internationalProcedure.taotlusteAeg + internationalProcedure.pakkumusteAeg;
                } else {
                    duration += procedure.taotlusteAeg + procedure.pakkumusteAeg;
                }

                duration += settings.documentPreparationDays;
                duration += settings.offerEvaluationDays;
                duration += settings.decisionDays;
                duration += settings.bidderEvaluationDays;
                duration += settings.successfulBidderDays;
                duration += settings.waitingPeriodDays;

                return duration;
            }

            calculateProcedureDetails() {
                const procedure = procedureData[this.procedureType];
                const internationalProcedure = internationalProcedureData[this.procedureType];
                const internationalThreshold = internationalProcedure.piirm√§√§r;
                let taotlusteAeg, pakkumusteAeg;

                if (this.cost > internationalThreshold || procedure.useInternational) {
                    taotlusteAeg = internationalProcedure.taotlusteAeg;
                    pakkumusteAeg = internationalProcedure.pakkumusteAeg;
                } else {
                    taotlusteAeg = procedure.taotlusteAeg;
                    pakkumusteAeg = procedure.pakkumusteAeg;
                }

                const details = [
                    { step: "Riigihanke alusdokumentide koostamine", days: ` ${settings.documentPreparationDays} p√§eva` },
                    { step: "Taotluste esitamine RHRis", days: taotlusteAeg ? `${taotlusteAeg} p√§eva` : "Ei kohaldu" },
                    { step: "Pakkumuste esitamine RHRis", days: pakkumusteAeg ? `${pakkumusteAeg} p√§eva` : "Ei kohaldu" },
                    { step: "Hindamine 1", days: `${settings.offerEvaluationDays} p√§eva` },
                    { step: "Otsus 1", days: `${settings.decisionDays} p√§eva` },
                    { step: "Hindamine 2", days: `${settings.bidderEvaluationDays} p√§eva` },
                    { step: "Otsus 2", days: `${settings.successfulBidderDays} p√§eva` },
                    { step: "Ooteaeg", days: `${settings.waitingPeriodDays} p√§eva` }
                ];
                return details;
            }

            calculateRequestSubmissionDate() {
                // Step 1: Ensure contractSigningDate is in YYYY-MM-DD format
                if (typeof this.contractSigningDate === "string" && this.contractSigningDate.includes(".")) {
                    const parts = this.contractSigningDate.split(".");
                    if (parts.length === 3) {
                        this.contractSigningDate = typeof this.contractSigningDate === "string" ? `${parts[2]}-${parts[1]}-${parts[0]}` : this.contractSigningDate; // Convert dd.mm.yyyy ‚Üí YYYY-MM-DD only if it's a string
                    }
                }

                // Step 2: Validate contractSigningDate before using it
                if (!this.contractSigningDate || isNaN(new Date(this.contractSigningDate).getTime())) {
                    console.error("Invalid contract signing date:", this.contractSigningDate);
                    return "Invalid date"; // Prevent further errors
                }

                // Step 3: Calculate the request submission date
                const submissionDate = new Date(this.contractSigningDate);
                if (!isNaN(this.procedureDuration)) {
                    submissionDate.setDate(submissionDate.getDate() - this.procedureDuration);
                    if (isNaN(submissionDate.getTime())) {
                        console.error("Invalid submission date:", submissionDate);
                        return "Invalid date"; // Prevents errors
                    }
                    return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
                    console.error("Invalid procedure duration:", this.procedureDuration);
                }

                // Step 4: Calculate expected quarter
                const month = submissionDate.getMonth() + 1;
                const year = submissionDate.getFullYear();
                this.expectedQuarter = `Q${Math.ceil(month / 3)} ${year}`;

                return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
            }

            generateHTML() {
                const detailsHTML = this.procedureDetails.map((detail, index) => `
                    <li class="flex flex-col py-2 border-b">
                        <div class="flex justify-between items-center">
                            <span class="w-3/4">${detail.step}:</span>
                            <span id="days-${index}" class="w-16 text-center font-medium whitespace-nowrap">${detail.days}</span>
                            <div class="flex gap-1 ml-6">
                                <button onclick="adjustDays(${index}, -1)" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition transform hover:scale-105">-</button>
                                <button onclick="adjustDays(${index}, 1)" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition transform hover:scale-105">+</button>
                            </div>
                        </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mt-1">
                            <div id="progress-${index}" class="progress-bar bg-blue-500 h-4 rounded-full transition-all duration-500" data-progress="0"></div>
                        </div>
                    </li>
                `).join('');

                const errorMessage = new Date(this.requestSubmissionDate) < new Date() ?
                    '<p class="error-message text-red-500 font-bold">NB! Oled hiljaks j√§√§nud, palun tutvu menetlusele kuluva ajaga ja korrigeeri lepingu s√µlmimise kuup√§eva</p>' : '';

                return `
                    <div class="result-card bg-white p-6 rounded max-w-lg">
                        <h2 class="text-2xl font-bold text-black-500 mb-4">Riigihanke andmed</h2>
                        <p><strong>Riigihanke taotluse esitamise kuup√§ev:</strong> 
                            <span id="requestSubmissionDate">${formatDate(this.requestSubmissionDate)}</span>
                        </p>
                        ${errorMessage}
                        <p><strong>Nimi:</strong> ${this.name}</p>
                        <p><strong>Maksumus:</strong> ${this.cost}</p>
                        <p><strong>Riigihanke menetlusliik:</strong> ${this.procedureType}</p>
                        <p><strong>Lepingu allkirjastamise kuup√§ev:</strong> ${formatDate(this.contractSigningDate)}</p>

                        <p><strong>Eeldatav riigihanke menetlusaeg p√§evades:</strong> <span id="totalDuration">${this.procedureDuration}</span> p√§eva</p>

                        <ul class="list-none p-0">
                            ${detailsHTML}
                        </ul>
                    </div>
                `;
                return html;
            }

            generateTableRow(index) {
                return `
                    <tr>
                        <td class="border p-2">${this.name}</td>
                        <td class="border p-2">${this.procedureType}</td>
                        <td class="border p-2">${this.expectedQuarter}</td>
                        <td class="border p-2">${this.cost}</td>
                        <td class="border p-2">${this.procedureDuration} p√§eva</td>
                        <td class="border p-2">${formatDate(this.requestSubmissionDate)}</td>
                        <td class="border p-2">${formatDate(this.contractSigningDate)}</td>
                        <td class="border p-2"><button class="edit-button bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 transition transform hover:scale-105" onclick="editSearch(${index})">Muuda</button></td>
                        <td class="border p-2"><button class="delete-button bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition transform hover:scale-105" onclick="deleteSearch(${index})">Kustuta</button></td>
                    </tr>
                `;
            }
        }

        function adjustDays(index, adjustment) {
            const daysElement = document.getElementById(`days-${index}`);
            if (!daysElement) {
                console.error(`Element with id days-${index} not found`);
                return;
            }

            let daysText = daysElement.innerText;
            let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);  // Avoid NaN
            days += adjustment;
            daysElement.innerText = daysText.replace(/\d+/, days);

            // Update total duration
            const totalDurationElement = document.getElementById('totalDuration');
            if (totalDurationElement) {
                let totalDuration = parseInt(totalDurationElement.innerText || "0", 10);
                totalDuration += adjustment;
                totalDurationElement.innerText = totalDuration;
            } else {
                console.error('Element with id totalDuration not found');
            }

            // Store updated total duration in the PublicProcurement object
            const procurement = savedSearches.find(p => p.name === document.getElementById('name').value);
            if (procurement) {
                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            } else {
                console.error("Could not find procurement object for real-time update.");
            }

            // ‚úÖ Kui kasutaja vajutab "adjustDays", ilmub "Uuenda andmed" nupp
            document.getElementById("updateProcurement").classList.remove("hidden");

            const stepData = extractStepDays().find(step => step.index === index);
            if (!stepData) return;

            let newDays = Math.max(0, stepData.days + adjustment);
            stepData.element.innerText = `${newDays} p√§eva`;

            updateTotalDuration();
            updateProgressBars();

        }

        const savedSearches = [];
        const history = [];

        document.getElementById('procurementForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const name = document.getElementById('name').value;
            const cost = parseFloat(document.getElementById('cost').value);
            const procedureType = document.getElementById('procedureType').value;
            const contractSigningDate = document.getElementById('contractSigningDate').value;

            const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);
            procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

            document.getElementById('result').innerHTML = procurement.generateHTML();

            // ‚úÖ Peidame "Uuenda andmed" nupu (ilmub ainult adjustDays muutmisel)
            document.getElementById("updateProcurement").classList.add("hidden");

            // ‚úÖ Progressi ja kestuse uuendamine
            setTimeout(() => {
                updateTotalDuration();
                updateProgressBars();
            }, 100);

            // ‚úÖ Kuvame tulemuste konteineri
            document.getElementById('resultContainer').classList.remove('hidden');

            // ‚úÖ Salvestame andmed Firestore'i kohe p√§rast arvutamist
            const user = auth.currentUser;
            if (user) {
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    let searches = userDoc.exists() ? userDoc.data().searches || [] : [];

                    // ‚úÖ Leia olemasolev hange v√µi lisa uus
                    const existingIndex = searches.findIndex(p => p.name === name);
                    if (existingIndex !== -1) {
                        searches[existingIndex] = { ...procurement, timestamp: new Date().toISOString() };
                    } else {
                        searches.push({ ...procurement, timestamp: new Date().toISOString() });
                    }

                    await updateDoc(userDocRef, { searches });

                    console.log("‚úÖ Taotluse esitamise kuup√§ev salvestatud Firestore'i:", procurement.requestSubmissionDate);
                } catch (error) {
                    console.error("‚ùå Firestore'i salvestamise viga:", error);
                }
            }

            // ‚úÖ Lisame andmed ka lokaalsesse `savedSearches` listi
            if (savedSearches.length < 15) {
                savedSearches.push(procurement);
                updateSavedSearchesTable();
            } else {
                alert("Maksimaalne salvestatud otsingute arv on 15.");
            }
        });

        document.getElementById('clearFields').addEventListener('click', function () {
            document.getElementById('procurementForm').reset();
            document.getElementById('result').innerHTML = '';
            document.getElementById('resultContainer').classList.add('hidden'); // Hide the result container
        });

        document.getElementById('saveFields').addEventListener('click', function () {
            const name = document.getElementById('name').value;
            const cost = parseFloat(document.getElementById('cost').value);
            const procedureType = document.getElementById('procedureType').value;
            const contractSigningDate = document.getElementById('contractSigningDate').value;

            const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);

            // Update procedure details with adjusted days
            procurement.procedureDetails.forEach((detail, index) => {
                const daysElement = document.getElementById(`days-${index}`);
                if (daysElement) {
                    let daysText = daysElement.innerText;
                    let match = daysText.match(/\d+/);
                    if (match) {
                        let days = parseInt(match[0]);
                        detail.days = `${days} p√§eva`;
                    } else {
                        console.error("No days found in text:", daysText);
                    }
                } else {
                    console.error("Element not found for index:", index);
                }
            })

            // Capture the adjusted procedureDuration value
            const totalDurationElement = document.getElementById('totalDuration');
            if (totalDurationElement) {
                procurement.procedureDuration = parseInt(totalDurationElement.innerText);
            } else {
                console.error("Total duration element not found");
            }

            procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

            // Update the displayed result
            document.getElementById('result').innerHTML = procurement.generateHTML();

            // Save the updated procurement
            const existingIndex = savedSearches.findIndex(p => p.name === name);
            if (existingIndex !== -1) {
                savedSearches[existingIndex] = procurement;
            } else {
                if (savedSearches.length < 15) {
                    savedSearches.push(procurement);
                } else {
                    alert("Maksimaalne salvestatud otsingute arv on 15.");
                }
            }

            // Save to history
            if (history.length >= 500) {
                history.shift(); // Remove the oldest entry if history exceeds 500
            }
            history.push(procurement);
            saveHistory(); // Save history immediately
        });

        document.getElementById('refreshFields').addEventListener('click', function () {
            const procurement = new PublicProcurement(
                document.getElementById('name').value,
                parseFloat(document.getElementById('cost').value),
                document.getElementById('procedureType').value,
                document.getElementById('contractSigningDate').value
            );

            procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
            procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
            document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            updateSavedSearchesTable();
        });

        document.getElementById('saveToExcel').addEventListener('click', function () {
            if (savedSearches.length === 0) {
                alert("Salvestatud otsinguid ei ole.");
                return;
            }

            // Define column headers
            const headers = [
                "Riigihanke Eseme Nimetus",
                "Riigihanke Menetluse Liik",
                "Riigihanke Korraldamise Eeldatav Aeg",
                "Riigihanke Eeldatav Maksumus (ilma KM-ta)",
                "S√µlmitava Lepingu Kehtivusaeg",
                "Riigihanke Eest Vastutav Isik",
                "Tehnilise Kirjelduse Eest Vastutav Isik"
            ];

            // Prepare data rows
            const data = savedSearches.map(procurement => [
                procurement.name || "",
                procurement.procedureType || "",
                getQuarter(procurement.applicationDate || "M√§√§ramata"),
                procurement.cost || "",
                "",  // Empty field for contract duration
                "",  // Empty field for responsible person
                ""   // Empty field for technical responsible person
            ]);

            // Combine headers and data
            const worksheetData = [headers, ...data];

            // Create a new workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);

            // Auto-width for columns
            ws['!cols'] = headers.map(() => ({ wch: 25 }));

            // Apply table formatting
            const range = XLSX.utils.decode_range(ws['!ref']);
            ws['!autofilter'] = { ref: XLSX.utils.encode_range(range) };

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Hankeplaan");

            // Export to .xlsx file
            XLSX.writeFile(wb, "hankeplaan.xlsx");
        });

        const getQuarter = (dateString) => {
            if (!dateString || dateString === "M√§√§ramata") return "M√§√§ramata"; // If no date, return "M√§√§ramata"

            const dateParts = dateString.split('.');
            if (dateParts.length !== 3) return "M√§√§ramata"; // Expecting "dd.mm.yyyy" format

            const month = parseInt(dateParts[1], 10);
            const year = dateParts[2];

            if (month >= 1 && month <= 3) return `1. kvartal ${year}`;
            if (month >= 4 && month <= 6) return `2. kvartal ${year}`;
            if (month >= 7 && month <= 9) return `3. kvartal ${year}`;
            if (month >= 10 && month <= 12) return `4. kvartal ${year}`;

            return "M√§√§ramata"; // Ensure a valid return value
        };
        // ‚úÖ Defineerime muutuja √ºleval, et v√§ltida "not defined" viga
        let resultContainerHTML = "";

        document.getElementById("showSavedSearches").addEventListener("click", function () {
            // ‚úÖ Salvestame resultContainer sisu enne selle peitmist
            resultContainerHTML = document.getElementById("resultContainer").innerHTML;
            document.getElementById("resultContainer").classList.add("hidden");
        });

        document.getElementById("showForm").addEventListener("click", function () {
            // ‚úÖ Kui resultContainerHTML on olemas, taastame selle
            if (resultContainerHTML) {
                document.getElementById("resultContainer").innerHTML = resultContainerHTML;
                document.getElementById("resultContainer").classList.remove("hidden");
            }
            setActiveTab(this);
        });

        document.getElementById('showSavedSearches').addEventListener('click', function () {
            saveResultContainerHTML();
            closeAllTabs();
            document.getElementById('savedSearchesContainer').classList.remove('hidden');
            updateSavedSearchesTable();
            setActiveTab(this);
        });

        document.getElementById('settingsButton').addEventListener('click', function () {
            saveResultContainerHTML();
            closeAllTabs();
            document.getElementById('settingsContainer').classList.remove('hidden');
            loadSettings();
            loadProcedureTypes();
            setActiveTab(this);
        });

        function setActiveTab(button) {
            const navButtons = document.querySelectorAll('.nav button');
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        function saveResultContainerHTML() {
            resultContainerHTML = document.getElementById('resultContainer').innerHTML;
        }

        function closeAllTabs() {
            document.getElementById('formContainer').classList.add('hidden');
            document.getElementById('savedSearchesContainer').classList.add('hidden');
            document.getElementById('settingsContainer').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
        }

        function updateSavedSearchesTable() {
            const tableBody = document.getElementById("savedSearchesTableBody");

            tableBody.innerHTML = ""; // Clear previous entries

            savedSearches.forEach((search, index) => {
                const row = `
                <tr class="border-b even:bg-gray-100 hover:bg-gray-200 transition-all">
                <td class="p-4 font-semibold text-gray-800">${search.name}</td>
                <td class="p-4 text-gray-700">${search.procedureType}</td>
                <td class="p-4 text-green-600 font-semibold">${search.cost} ‚Ç¨</td>
                <td class="p-4 text-blue-600 font-semibold">${search.procedureDuration} p√§eva</td>
                <td class="p-4 text-gray-500">${formatDate(search.requestSubmissionDate)}</td>
                <td class="p-4 text-gray-500">${formatDate(search.contractSigningDate)}</td>
                <td class="p-4 text-center">
                    <button onclick="editSearch(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105">
                    ‚úèÔ∏è Muuda
                    </button>
                </td>
                <td class="p-4 text-center">
                    <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">
                    ‚ùå Kustuta
                    </button>
                </td>
                </tr>
            `;
                tableBody.innerHTML += row;
            });
        }
        let deleteIndex = null; // Hoiab ajutiselt indeksi, mida kustutada soovitakse

        async function deleteSearch(index) {
            deleteIndex = index; // Salvestame kustutatava indeksi
            document.getElementById("deleteConfirmModal").classList.remove("hidden"); // Kuvame modali
        }


        async function updateProcurementInFirestore() {
            const user = auth.currentUser;
            if (!user) {
                alert("Salvestamiseks peab olema sisse logitud!");
                return;
            }

            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    console.error("‚ùå Kasutaja dokumenti ei leitud Firestore'ist.");
                    return;
                }

                let searches = userDoc.data().searches || [];
                const procurementName = document.getElementById('name').value;
                const searchIndex = searches.findIndex(s => s.name === procurementName);

                if (searchIndex === -1) {
                    console.warn("‚ö† Firestore'is ei leitud vastavat hanget, ei saa uuendada.");
                    return;
                }

                // ‚úÖ Kontrollime, kas kuup√§evad on korrektsed enne Firestore'i uuendamist
                let newRequestDate = document.getElementById('requestSubmissionDate').innerText;
                console.log("üü° Kontrollime kuup√§eva enne formatDate():", newRequestDate);
                let formattedRequestDate = formatDate(newRequestDate);

                searches[searchIndex].procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                searches[searchIndex].requestSubmissionDate = formatDate(
                    new Date(document.getElementById('requestSubmissionDate').innerText)
                );

                await updateDoc(userDocRef, { searches });

                console.log("‚úÖ Hange Firestore'is uuendatud:", searches[searchIndex]);

                // üîÑ Peidame nupu uuesti ja uuendame "Hanked" tabelit
                document.getElementById("updateProcurement").classList.add("hidden");
                loadUserSearches();
            } catch (error) {
                console.error("‚ùå Firestore'i uuendamise viga:", error);
            }
        }

        document.getElementById("confirmDelete").addEventListener("click", async () => {
            if (deleteIndex === null) return; // Kui indeks puudub, √§ra tee midagi

            const user = auth.currentUser;
            if (!user) {
                alert("Kustutamiseks peab olema sisse logitud!");
                return;
            }

            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    console.error("‚ùå Kasutaja dokumenti ei leitud Firestore'ist.");
                    return;
                }

                let searches = userDoc.data().searches || [];

                if (deleteIndex < 0 || deleteIndex >= searches.length) {
                    console.error("‚ùå Kehtetu indeks:", deleteIndex);
                    return;
                }

                const searchToDelete = searches[deleteIndex];

                console.log("üî¥ Enne kustutamist:", searches);
                console.log("üö® Kustutame:", searchToDelete);

                // üî• Kustutame Firestore'ist ainult selle konkreetse objekti
                await updateDoc(userDocRef, {
                    searches: searches.filter((_, i) => i !== deleteIndex)
                });

                console.log("‚úÖ Otsing kustutatud Firestore'ist:", searchToDelete);

                // üïí Lisame animatsiooni ja eemaldame rea tabelist
                const tableBody = document.getElementById("savedSearchesTableBody");
                const rowToRemove = tableBody.children[deleteIndex];

                if (rowToRemove) {
                    rowToRemove.classList.add("fade-out"); // Lisame CSS animatsiooni
                    setTimeout(() => rowToRemove.remove(), 500); // Eemaldame rea p√§rast animatsiooni
                }

                deleteIndex = null; // Nullime indeksi p√§rast kustutamist
                document.getElementById("deleteConfirmModal").classList.add("hidden"); // Sulgeme modali

            } catch (error) {
                console.error("‚ùå Firestore'i kustutamise viga:", error);
            }
        });

        document.getElementById("cancelDelete").addEventListener("click", () => {
            deleteIndex = null; // T√ºhistame kustutamise
            document.getElementById("deleteConfirmModal").classList.add("hidden"); // Peidame modali
        });

        function editSearch(index) {
            const procurement = savedSearches[index];
            document.getElementById('name').value = procurement.name;
            document.getElementById('cost').value = procurement.cost;
            document.getElementById('procedureType').value = procurement.procedureType;
            document.getElementById('contractSigningDate').value = procurement.contractSigningDate.toISOString().split('T')[0];
            deleteSearch(index);
            closeAllTabs();
            document.getElementById('formContainer').classList.remove('hidden');
            setActiveTab(document.getElementById('showForm'));
        }

        function refreshDuration(index) {
            const procurement = savedSearches[index];
            procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
            procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
            document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            updateSavedSearchesTable();
        }

        function updateHistoryTable() {
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            history.forEach((procurement, index) => {
                console.log('Adding row for:', procurement); // Debugging statement
                tableBody.innerHTML += procurement.generateTableRow(index);
            });
            populateFilterOptions();
        }

        function populateFilterOptions() {
            const filterSelect = document.getElementById('filterByDate');
            const dates = [...new Set(history.map(procurement => procurement.contractSigningDate.toISOString().split('T')[0]))];
            filterSelect.innerHTML = '<option value="all">K√µik</option>';
            dates.forEach(date => {
                filterSelect.innerHTML += `<option value="${date}">${date}</option>`;
            });
        }

        document.getElementById('filterByDate').addEventListener('change', function () {
            const selectedDate = this.value;
            const filteredHistory = selectedDate === 'all' ? history : history.filter(procurement => procurement.contractSigningDate.toISOString().split('T')[0] === selectedDate);
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            filteredHistory.forEach((procurement, index) => {
                tableBody.innerHTML += procurement.generateTableRow(index);
            });
        });

        document.getElementById('toggleDarkMode').addEventListener('click', function () {
            document.body.classList.toggle('bg-gray-900');
            document.body.classList.toggle('text-white');
        });

        function adjustTableColumns() {
            const tables = document.querySelectorAll('table');
            tables.forEach(table => {
                const columns = table.querySelectorAll('th');
                columns.forEach((column, index) => {
                    let maxWidth = 0;
                    const cells = table.querySelectorAll(`td:nth-child(${index + 1})`);
                    cells.forEach(cell => {
                        const cellWidth = cell.offsetWidth;
                        if (cellWidth > maxWidth) {
                            maxWidth = cellWidth;
                        }
                    });
                    column.style.width = `${maxWidth}px`;
                });
            });
        }

        document.getElementById('dropdownButton').addEventListener('click', function () {
            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.classList.toggle('hidden');
        });

        document.addEventListener('click', function (event) {
            const dropdownButton = document.getElementById('dropdownButton');
            const dropdownMenu = document.getElementById('dropdownMenu');
            if (!dropdownButton.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });

        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('toggleDarkMode');
        darkModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('bg-gray-900');
            document.body.classList.toggle('text-white');

            // Navbar, header, and tab menu
            // Fix navbar & header gradient
            const header = document.querySelector('header');
            if (darkModeToggle.checked) {
                header.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600');
                header.classList.add('bg-gray-800');
            } else {
                header.classList.remove('bg-gray-800');
                header.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600');
            }

            // Ensure navbar links stay visible
            document.querySelectorAll('nav a').forEach(el => {
                el.classList.toggle('text-gray-300');
                el.classList.toggle('text-white');
            });

            document.querySelectorAll('header, nav, .tab-content').forEach(el => {
                el.classList.toggle('bg-gray-800');
                el.classList.toggle('text-white');
            });

            // Containers & content boxes
            document.querySelectorAll('.container, .shadow, .rounded-lg, .bg-white, .bg-gray-100, .bg-gray-50').forEach(el => {
                el.classList.toggle('bg-gray-800');
                el.classList.toggle('text-gray-200');
            });

            // Tables
            document.querySelectorAll('table').forEach(el => {
                el.classList.toggle('bg-gray-700');
                el.classList.toggle('text-gray-300');
            });

            // Table headers
            document.querySelectorAll('thead tr').forEach(el => {
                el.classList.toggle('bg-gray-600');
            });

            // Buttons
            document.querySelectorAll('button').forEach(el => {
                el.classList.toggle('shadow-lg');
                el.classList.toggle('border-gray-700');
            });

            // Form Inputs & Select Boxes
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.classList.toggle('bg-gray-700');
                el.classList.toggle('text-white');
                el.classList.toggle('border-gray-600');
            });

            // Save dark mode preference in localStorage
            if (document.body.classList.contains('bg-gray-900')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.setItem('darkMode', 'disabled');
            }
        });

        // Show Notification
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, duration);
        }

        document.getElementById('saveFields').addEventListener('click', function () {
            // Your save logic here
            showNotification('Salvestatud edukalt!');
        });

        document.getElementById('refreshFields').addEventListener('click', function () {
            // Your update logic here
            showNotification('Uuendatud edukalt!');
        });

        function toggleChart() {
            const chartContainer = document.getElementById("chartContainer");
            chartContainer.classList.toggle("hidden");

            // Ensure table has data before rendering
            if (!chartContainer.classList.contains("hidden")) {
                setTimeout(() => {
                    if (document.querySelectorAll("#savedSearchesTableBody tr").length > 0) {
                        renderChart();
                    } else {
                        console.warn("‚ö† No saved searches found, chart cannot be displayed.");
                    }
                }, 300);
            }
        }

        function renderChart() {
            const canvas = document.getElementById("procurementChart");
            if (!canvas) {
                console.error("‚ùå Chart canvas not found!");
                return;
            }

            const ctx = canvas.getContext("2d");

            // Destroy previous chart if it exists
            if (window.procurementChart && typeof window.procurementChart.destroy === 'function') {
                window.procurementChart.destroy();
            }

            // Extract data from savedSearchesTableBody
            const rows = document.querySelectorAll("#savedSearchesTableBody tr");
            const labels = [];
            const costs = [];
            const totalDays = [];

            rows.forEach(row => {
                const columns = row.querySelectorAll("td");
                if (columns.length >= 5) {  // Ensure there are enough columns
                    const name = columns[0].innerText.trim();
                    const cost = parseFloat(columns[2].innerText.replace("‚Ç¨", "").trim()); // Remove ‚Ç¨ sign
                    const days = parseInt(columns[3].innerText.trim(), 10); // Convert to integer

                    if (!isNaN(cost) && !isNaN(days)) { // Ensure valid data
                        labels.push(name);
                        costs.push(cost);
                        totalDays.push(days);
                    }
                }
            });

            // If no valid data, show a warning and prevent chart initialization
            if (labels.length === 0) {
                console.warn("‚ö† No valid data found for the chart.");
                return;
            }

            // Create the chart
            window.procurementChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Menetlusaeg (p√§evad)",
                            data: totalDays.map(days => {
                                const today = new Date();
                                const submissionDate = new Date();
                                submissionDate.setDate(today.getDate() + days);
                                const timeDiff = submissionDate.getTime() - today.getTime();
                                return Math.ceil(timeDiff / (1000 * 3600 * 24));
                            }),
                            backgroundColor: "rgba(153, 102, 255, 0.6)",
                            borderColor: "rgba(153, 102, 255, 1)",
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: { enabled: true }
                    }
                }
            });
        }

        // Attach event listeners to navbar buttons
        document.addEventListener("DOMContentLoaded", function () {
            const navTool = document.getElementById("showForm");
            const navHanked = document.getElementById("showSavedSearches");
            const navHistory = document.getElementById("showHistory");
            const navSettings = document.getElementById("settingsButton");

            if (navTool) navTool.addEventListener("click", () => showTab('formContainer'));
            if (navHanked) navHanked.addEventListener("click", () => showTab('savedSearchesContainer'));
            if (navHistory) navHistory.addEventListener("click", () => showTab('historyContainer'));
            function showTab(tabId) {
                closeAllTabs();
                document.getElementById(tabId).classList.remove('hidden');
            }
            // Initialize Chart.js
            renderChart();
        });
        function toggleDashboard() {
            const dashboard = document.getElementById("dashboard");
            const recentCalculationsTable = document.getElementById("recentCalculationsTable");
            dashboard.classList.toggle("hidden");
            recentCalculationsTable.classList.toggle("hidden");
        }

        // Ensure the container fades in on page load
        document.addEventListener("DOMContentLoaded", () => {
            gsap.from("body", { opacity: 0, duration: 0.3 });
            updateTotalDuration(); // Ensure total duration is calculated and progress bars are updated on load
        });

        function updateProgressBars() {
            const stepData = extractStepDays();
            const totalDurationElement = document.getElementById('totalDuration');
            const totalDuration = parseInt(totalDurationElement?.innerText, 10) || 1; // Get total durationtotal duration

            stepData.forEach(step => {
                const progressBar = document.getElementById(`progress-${step.index}`);
                if (progressBar) {
                    // Hide the progress bar if "Ei kohaldu"
                    if (step.element.innerText.includes("Ei kohaldu")) {
                        progressBar.style.display = "none";
                        return;
                    } else {
                        progressBar.style.display = "block";
                    }

                    // Scale width dynamically based on the total duration
                    let progressWidth = (step.days / totalDuration) * 100 * 1.25;
                    progressBar.dataset.progress = progressWidth.toFixed(2);

                    // üöÄ FORCE width and color immediately before animation
                    progressBar.style.width = `${progressWidth}%`;

                    // Apply colors dynamically based on percentage of total duration
                    progressBar.classList.remove("bg-blue-500", "bg-green-500", "bg-yellow-500", "bg-red-500");
                    if (progressWidth >= 25) {
                        progressBar.classList.add("bg-red-500"); // Very long duration
                    } else if (progressWidth >= 14) {
                        progressBar.classList.add("bg-yellow-500"); // Medium duration
                    } else {
                        progressBar.classList.add("bg-green-500"); // Short duration
                    }
                    setTimeout(() => {
                        gsap.to(progressBar, { width: `${progressWidth}%`, duration: 0.8, ease: "power2.out" });
                    }, 10); // Small delay ensures colors are visible first
                }
            });
        }

        function extractStepDays() {
            return Array.from(document.querySelectorAll('[id^="days-"]')).map((el, index) => {
                let daysText = el.innerText;
                let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);
                return { index, element: el, days };
            });
        }

        function updateTotalDuration() {
            const totalDurationElement = document.getElementById('totalDuration');
            if (!totalDurationElement) return;

            const totalDays = extractStepDays().reduce((sum, step) => sum + step.days, 0);
            totalDurationElement.innerText = totalDays;

            updateProgressBars();
        }

        function adjustDays(index, adjustment) {
            const stepData = extractStepDays().find(step => step.index === index);
            if (!stepData) return;

            let newDays = Math.max(0, stepData.days + adjustment);
            stepData.element.innerText = `${newDays} p√§eva`;

            updateTotalDuration(); // Update total duration
            updateProgressBars();  // Update progress bars dynamically

            // Update the request submission date
            const procurement = savedSearches.find(p => p.name === document.getElementById('name').value);
            if (procurement) {
                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            } else {
                console.error("Could not find procurement object for real-time update.");
            }
        }

        function initializeAdjustButtons() {
            document.querySelectorAll("button[data-adjust]").forEach(button => {
                button.addEventListener("click", function () {
                    const index = parseInt(this.dataset.index, 10);
                    const adjustment = parseInt(this.dataset.adjust, 10);
                    adjustDays(index, adjustment);
                });
            });
        }

        document.addEventListener("readystatechange", function () {
            if (document.readyState === "complete") {
                console.log("Page fully loaded. Initializing scripts...");
                initializeAdjustButtons();
                updateTotalDuration();  // üî• Ensures total duration starts correctly
                updateProgressBars();   // üî• Ensures progress bars scale correctly on load
            }

            async function registerUser(email, password) {
                const { user } = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", user.uid), {
                    email: email,
                    role: "active",
                    approved: false
                });
            }

            // ‚úÖ Kui kasutaja vajutab "adjustDays", teeme "Uuenda andmed" nupu n√§htavaks
            document.getElementById("updateProcurement").classList.remove("hidden");

            // ‚úÖ Kontrollime, kas event listener on juba lisatud, et v√§ltida topelt kuulamist
            const updateButton = document.getElementById("updateProcurement");
            if (updateButton && !updateButton.dataset.listenerAdded) {
                updateButton.addEventListener("click", async () => {
                    console.log("üîÑ Uuendame hanke andmeid Firestore'is...");
                    await updateProcurementInFirestore();
                });
                updateButton.dataset.listenerAdded = "true"; // M√§rgime, et listener on lisatud
            }
        });
    </script>

    <style>
        /* Navbar button hover effect */
        .nav-button {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .nav-button:hover {
            background-color: rgba(233, 253, 254, 0.2);
            transform: scale(1.05);
        }

        /* Navbar styling */
        .navbar {
            position: fixed;
            top: 0;
            z-index: 50;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        /* Ensure the clock is fixed in the corner */
        #currentDateTime {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        /* Navbar Links */
        .nav-link {
            padding-bottom: 4px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            opacity: 0.8;
        }

        .active-tab {
            border-bottom-width: 2px;
            border-color: white;
        }

        /* ‚úÖ Fade-out efekt rea eemaldamiseks */
        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        // Active Tab Highlighting
        document.addEventListener('DOMContentLoaded', function () {
            const navLinks = document.querySelectorAll('.nav-link');

            function setActiveTab(event) {
                navLinks.forEach(link => link.classList.remove('border-b-2', 'border-white'));
                event.target.classList.add('border-b-2', 'border-white');
            }

            navLinks.forEach(link => {
                link.addEventListener('click', setActiveTab);
            });
        });

        //menetlusliigi nimi
        document.addEventListener("DOMContentLoaded", function () {
            const procedureSelect = document.getElementById("procedureType");
            const procedureLabel = document.getElementById("procedureLabel");

            function updateProcedureLabel() {
                const selectedOption = procedureSelect.options[procedureSelect.selectedIndex];
                const optgroup = selectedOption.closest("optgroup"); // Find parent optgroup

                if (optgroup) {
                    procedureLabel.innerText = `${optgroup.label}`;

                    // Animate fade-in effect
                    gsap.to(procedureLabel, { opacity: 1, y: 5, duration: 0.5, ease: "power2.out" });
                } else {
                    gsap.to(procedureLabel, { opacity: 0, duration: 0.3 });
                }
            }

            // Update on selection change
            procedureSelect.addEventListener("change", updateProcedureLabel);

            // Run once on page load to show the initially selected value
            updateProcedureLabel();
        });

        document.addEventListener("DOMContentLoaded", function () {
            function animateProgressBars() {
                document.querySelectorAll(".progress-bar").forEach(bar => {
                    gsap.to(bar, { width: bar.dataset.progress + "%", duration: 1.5, ease: "power2.out" });
                });
            }

            function extractStepDays() {
                return Array.from(document.querySelectorAll('[id^="days-"]')).map((el, index) => {
                    let daysText = el.innerText;
                    let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);
                    return { index, element: el, days };
                });
            }
            function updateTotalDuration() {
                const totalDurationElement = document.getElementById('totalDuration');
                if (!totalDurationElement) return;

                const totalDays = extractStepDays().reduce((sum, step) => sum + step.days, 0);
                totalDurationElement.innerText = totalDays;

                updateProgressBars();
            }

            function adjustDays(index, adjustment) {
                const stepData = extractStepDays().find(step => step.index === index);
                if (!stepData) return;

                let newDays = Math.max(0, stepData.days + adjustment);
                stepData.element.innerText = `${newDays} p√§eva`;

                updateTotalDuration(); // Update total duration
                updateProgressBars();  // Update progress bars dynamically
            }

            function initializeAdjustButtons() {
                document.querySelectorAll("button[data-adjust]").forEach(button => {
                    button.addEventListener("click", function () {
                        const index = parseInt(this.dataset.index, 10);
                        const adjustment = parseInt(this.dataset.adjust, 10);
                        adjustDays(index, adjustment);
                    });
                });
            }

            document.addEventListener("readystatechange", function () {
                if (document.readyState === "complete") {
                    console.log("Page fully loaded. Initializing scripts...");
                    initializeAdjustButtons();
                    updateTotalDuration();  // üî• Ensures total duration starts correctly
                    updateProgressBars();   // üî• Ensures progress bars scale correctly on load
                    setTimeout(updateProgressBars, 500); // üî• Second pass to ensure visibility
                }
            });
        });
    </script>

    <!-- Firebase Authentication Logic (Add before closing body tag) -->
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        // ‚úÖ Firebase initsialiseerimine
        const auth = getAuth();
        const db = getFirestore();

        document.addEventListener("DOMContentLoaded", () => {
            console.log("üöÄ Page Loaded - Waiting for login or guest selection.");

            // ‚úÖ Buttons
            const loginButton = document.getElementById("loginButton");
            const registerButton = document.getElementById("registerButton");
            const guestButton = document.getElementById("guestButton");
            const logoutButton = document.getElementById("logoutButton");
            const settingsButton = document.getElementById("settingsButton");
            const showHankedButton = document.getElementById("showSavedSearches");

            // ‚úÖ Sections
            const hankedSection = document.getElementById("savedSearchesContainer");
            const settingsSection = document.getElementById("settingsContainer");
            const adminTab = document.getElementById("adminTab");

            // üî• Peidame "Hanked" ja "Seaded" esialgu
            hankedSection?.classList.add("hidden");
            settingsSection?.classList.add("hidden");

            // ‚úÖ "Hanked" nupp laadib andmed Firestore'ist ja kuvab need
            showHankedButton?.addEventListener("click", async () => {
                console.log("üìÇ 'Hanked' nuppu vajutati, laen Firestore andmed...");
                await loadUserSearches();
                hankedSection?.classList.remove("hidden");
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("‚úÖ Kasutaja sisse logitud:", user.email);

                    // ‚úÖ Eemaldame hidden klassi, et kuvada men√º√ºnupud
                    showHankedButton?.classList.remove("hidden");
                    settingsButton?.classList.remove("hidden");

                    // ‚úÖ Peidame sisselogimisnupud ja kuvame "Logi v√§lja" nupu
                    loginButton?.classList.add("hidden");
                    registerButton?.classList.add("hidden");
                    guestButton?.classList.add("hidden");
                    logoutButton?.classList.remove("hidden");

                    // ‚úÖ Kontrollime Firestore rolli
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        console.log("üìú Firestore roll:", userData.role);

                        if (userData.role === "admin") {
                            adminTab?.classList.remove("hidden");
                        } else {
                            adminTab?.classList.add("hidden");
                        }
                    }
                } else {
                    console.log("üö´ Kasutaja pole sisse logitud.");

                    // ‚úÖ Peidame "Hanked", "Seaded" ja "Admin" vahelehed
                    showHankedButton?.classList.add("hidden");
                    settingsButton?.classList.add("hidden");
                    adminTab?.classList.add("hidden");

                    // ‚úÖ Kuvame sisselogimisnupud ja peidame "Logi v√§lja" nupu
                    loginButton?.classList.remove("hidden");
                    registerButton?.classList.remove("hidden");
                    guestButton?.classList.remove("hidden");
                    logoutButton?.classList.add("hidden");
                }
            });

            // üî• Logout Button Click Event
            logoutButton?.addEventListener("click", async () => {
                console.log("üî¥ Logging out user...");
                await signOut(auth);
                window.location.href = "index.html";
            });

            // ‚úÖ Funktsioon otsingu salvestamiseks Firestore'i
            const saveSearchToFirestore = async (searchData) => {
                const user = auth.currentUser;
                if (!user) {
                    showNotification("Andmete salvestamiseks peab olema sisse logitud!", 3000);
                    return;
                }

                try {
                    await updateDoc(doc(db, "users", user.uid), {
                        searches: arrayUnion(searchData)
                    });
                    showNotification("‚úÖ Otsing salvestatud Firestore'i!", 3000);
                    console.log("‚úÖ Otsing salvestatud Firestore'i:", searchData);
                } catch (error) {
                    showNotification("‚ùå Otsingu salvestamise viga!", 3000);
                    console.error("‚ùå Otsingu salvestamise viga:", error);
                }
            };

            // ‚úÖ Seome otsingu salvestamise "Arvuta menetlusaeg" nupuga
            document.getElementById("procurementForm").addEventListener("submit", async (event) => {
                event.preventDefault();

                const name = document.getElementById("name").value;
                const cost = parseFloat(document.getElementById("cost").value);
                const procedureType = document.getElementById("procedureType").value;
                const contractSigningDate = document.getElementById("contractSigningDate").value;

                if (!name || !cost || !procedureType || !contractSigningDate) {
                    alert("Palun t√§ida k√µik v√§ljad!");
                    return;
                }

                const searchData = {
                    name,
                    cost,
                    procedureType,
                    contractSigningDate,
                    timestamp: new Date().toISOString()
                };

                await saveSearchToFirestore(searchData);
            });

            // ‚úÖ Funktsioon otsingute laadimiseks Firestore'ist
            async function loadUserSearches() {
                console.log("üì• Laen kasutaja otsingud Firestore'ist...");
                const user = auth.currentUser;
                if (!user) {
                    console.warn("‚ö† Kasutaja ei ole sisse logitud.");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        console.warn("‚ö† Kasutaja andmeid Firestore'is ei leitud.");
                        return;
                    }

                    let searches = userDoc.data().searches || [];

                    // ‚úÖ Kontrollime ja korrastame iga hanke kuup√§eva enne kuvamist
                    searches.forEach((search, index) => {
                        if (!search.requestSubmissionDate) {
                            console.warn(`‚ö† Otsingul [${index}] puudub requestSubmissionDate`);
                        }
                        if (!search.contractSigningDate) {
                            console.warn(`‚ö† Otsingul [${index}] puudub contractSigningDate`);
                        }

                        search.requestSubmissionDate = search.requestSubmissionDate
                            ? formatDate(search.requestSubmissionDate)
                            : "M√§√§ramata";

                        search.contractSigningDate = search.contractSigningDate
                            ? formatDate(search.contractSigningDate)
                            : "M√§√§ramata";

                        search.timestamp = search.timestamp
                            ? new Date(search.timestamp).toLocaleDateString() + " " + new Date(search.timestamp).toLocaleTimeString()
                            : "M√§√§ramata";
                    });

                    displaySearches(searches);
                } catch (error) {
                    console.error("‚ùå Firestore'i andmete laadimise viga:", error);
                }
            }
            const deleteSearch = async (index) => {
                const user = auth.currentUser;
                if (!user) {
                    alert("Kustutamiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        let searches = userDoc.data().searches || [];

                        if (index < 0 || index >= searches.length) {
                            console.error("‚ùå Kehtetu indeks:", index);
                            return;
                        }

                        const searchToDelete = searches[index];

                        // üîç Kontrollime, milline element kustutatakse
                        console.log("üî¥ Enne kustutamist:", searches);
                        console.log("üö® Kustutame:", searchToDelete);

                        // üî• Kustutame Firestore'ist ainult selle konkreetse objekti
                        await updateDoc(userDocRef, {
                            searches: arrayRemove(searchToDelete),
                        });

                        console.log("‚úÖ Otsing kustutatud Firestore'ist:", searchToDelete);

                        // üîÑ Laadime uuesti andmed, et v√§rskendada tabelit
                        await loadUserSearches();
                    }
                } catch (error) {
                    console.error("‚ùå Firestore'i kustutamise viga:", error);
                }
            };

            // ‚úÖ Funktsioon otsingute kuvamiseks tabelis
            const displaySearches = (searches) => {
                const container = document.getElementById("savedSearchesTableBody");
                if (!container) {
                    console.error("‚ùå Ei leitud tabeli keha: savedSearchesTableBody");
                    return;
                }

                console.log("üîé Kuvan otsingud tabelisse:", searches);
                container.innerHTML = ""; // Tabeli puhastamine

                if (searches.length === 0) {
                    container.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">‚ö† Ei leitud salvestatud otsinguid.</td></tr>`;
                    return;
                }

                searches.forEach((search, index) => {
                    // ‚úÖ Kontrollime, et kuup√§evad on olemas enne formateerimist
                    const requestSubmissionDate = search.requestSubmissionDate ? formatDate(search.requestSubmissionDate) : "M√§√§ramata";
                    const contractSigningDate = search.contractSigningDate ? formatDate(search.contractSigningDate) : "M√§√§ramata";

                    container.innerHTML += `
                        <tr class="border-b even:bg-gray-100 hover:bg-gray-200 transition-all">
                            <td class="p-4">${search.name}</td>
                            <td class="p-4">${search.procedureType}</td>
                            <td class="p-4">${search.cost} ‚Ç¨</td>
                            <td class="p-4 text-blue-600 font-semibold">${formatDate(search.requestSubmissionDate)}</td>
                            <td class="p-4 text-gray-500">${formatDate(search.contractSigningDate)}</td>
                            <td class="p-4 text-center">
                                <button onclick="editSearch(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105">‚úèÔ∏è Muuda</button>
                            </td>
                            <td class="p-4 text-center">
                                <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">‚ùå Kustuta</button>
                            </td>
                        </tr>
        `;
                });

                console.log("‚úÖ Otsingud lisatud tabelisse!");
            };
        });
    </script>
</body>

</html>