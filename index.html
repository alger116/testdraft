<!DOCTYPE html>
<html lang="et">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riigihanke Andmed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="dist/output.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="config.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, setDoc, updateDoc, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        if (!window.FIREBASE_CONFIG) {
            console.error("⚠ Firebase konfiguratsiooni ei leitud! Kontrolli, kas `config.js` on õigesti laaditud.");
        } else {
            const app = initializeApp(window.FIREBASE_CONFIG);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Tee Firebase objektid globaalselt kättesaadavaks
            window.auth = auth;
            window.db = db;
        }

        // ✅ Lisa Firestore ja muud funktsioonid globaalseks
        window.auth = auth;
        window.db = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.arrayRemove = arrayRemove;

        function loadUserSearches() {
            console.log("📥 Laen kasutaja otsingud Firestore'ist...");
            // Firestore päringud siia
        }
        window.loadUserSearches = loadUserSearches;

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-gradient-to-r from-gray-100 to-gray-300 min-h-screen flex flex-col">
    <!-- Modern Navbar with Active Tab Highlighting -->
    <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-2 shadow-md w-full sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <!-- ✅ Keskendatud sisselogimise teade -->
            <div id="loginNotification"
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hidden">
                ✅
            </div>
            <div id="notification"
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md hidden">
                Andmete salvestamiseks peab olema sisse logitud!
            </div>
            <footer
                class="bg-opacity-80 from-blue-500 to-indigo-600 text-black py-2 fixed bottom-0 left-0 w-full shadow-md backdrop-blur-md">
                <div class="container mx-auto flex justify-between items-center px-6 text-sm">
                    <p class="text-sm">&copy; 2025 Riigihanke Andmed. Kõik õigused kaitstud.</p>
                    <div class="flex space-x-4">
                        <a href="#" class="hover:underline">Lingid</a>
                        <a href="#" class="hover:underline">Kasutusjuhend</a>
                        <a href="#" class="hover:underline">Kontakt</a>
                    </div>
                </div>
            </footer>

            <!-- ✅ Title + Dropdown (Left Side) -->
            <div class="flex items-center space-x-4 relative">
                <h1 class="text-2xl font-bold">
                    <a href="index.html" class="hover:underline">Riigihanke andmed</a>
                </h1>
                <!-- ✅ Dropdown Button (Aligned Right, Opens Down) -->
                <div class="dropdown dropdown-hover">
                    <button id="dropdownButton" class="btn btn-primary" aria-label="open on hover">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>

                    <!-- ✅ Dropdown Menu (Now Opens Down) -->
                    <div id="dropdownMenu"
                        class="hidden absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="dropdownButton">

                            <button id="showForm"
                                class="block px-4 py-2 text-sm text-gray-800 w-full text-left hover:bg-blue-600 hover:text-white transition transform hover:scale-105"
                                role="menuitem">
                                <i class="fas fa-tools mr-2"></i> Tööriist
                            </button>
                            <button id="showSavedSearches" class="block px-4 py-2 text-sm text-gray-800 hover:bg-blue-600 hover:text-white w-full text-left transition transform hover:scale-105 protected-section hidden
                                role=" menuitem">
                                <i class="fas fa-folder-open mr-2"></i> Hanked
                            </button>
                            <button id="settingsButton"
                                class="block px-4 py-2 text-sm text-gray-800 hover:bg-blue-600 hover:text-white w-full text-left transition transform hover:scale-105 protected-section hidden"
                                role="menuitem">
                                <i class="fas fa-cog mr-2"></i> Seaded
                            </button>
                            <a href="admin.html" id="adminTab" class="block px-4 py-2 text-sm text-gray-800 hover:bg-blue-600 hover:text-white w-full text-left transition transform hover:scale-105 protected-section hidden
                                role=" menuitem">
                                <i class="fas fa-user-shield mr-2"></i> Admin
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ✅ Right Side (Login, Register, Logout, Dark Mode) -->
            <nav class="flex space-x-4 items-center">
                <div x-data="{ open: false }" class="relative">
                    <!-- ✅ Login Button (Opens Modal) -->
                    <button id="loginButton" @click="open = true"
                        class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-1 rounded-lg flex items-center justify-center shadow-md hover:from-blue-600 hover:to-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300">
                        <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
                    </button>

                    <!-- ✅ Modal -->
                    <div x-show="open" x-cloak x-ref="loginModal"
                        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                        <div class="card w-96 bg-white shadow-xl p-8 rounded-xl border border-gray-200 relative">
                            <!-- ❌ Close Button -->
                            <button @click="open = false"
                                class="absolute top-2 right-2 text-gray-500 hover:text-red-500">
                                ✖
                            </button>

                            <h2 class="text-3xl font-bold text-center text-gray-900 mb-4">Logi sisse</h2>

                            <!-- ✅ Email Input -->
                            <div class="form-control w-full mb-3">
                                <label class="label text-gray-700 font-medium">E-post</label>
                                <input type="email" id="emailLogin" placeholder="Sisesta oma e-post"
                                    class="input input-bordered w-full text-gray-900 shadow-md rounded-lg p-3 focus:ring-2 focus:ring-blue-400 transition-all duration-300" />
                            </div>

                            <!-- ✅ Password Input -->
                            <div class="form-control w-full mb-3">
                                <label class="label text-gray-700 font-medium">Parool</label>
                                <input type="password" id="passwordLogin" placeholder="Sisesta oma parool"
                                    class="input input-bordered w-full text-gray-900 shadow-md rounded-lg p-3 focus:ring-2 focus:ring-blue-400 transition-all duration-300" />
                            </div>

                            <!-- ✅ Login Button -->
                            <button @click="login(); open = false"
                                class="btn btn-primary w-full mt-4 flex items-center justify-center transition-transform hover:scale-105 shadow-lg text-lg py-3 rounded-lg font-semibold bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white">
                                <i class="fas fa-sign-in-alt mr-2"></i> Logi sisse
                            </button>
                        </div>
                    </div>
                </div>



                <!-- ✅ Firebase Login Script -->
                <script type="module">
                    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

                    window.login = async () => {
                        try {
                            const email = document.getElementById("emailLogin").value;
                            const password = document.getElementById("passwordLogin").value;
                            await signInWithEmailAndPassword(auth, email, password);

                            // ✅ Kuvame teate
                            const notification = document.getElementById("loginNotification");
                            notification.classList.remove("hidden");

                            // ✅ Sulgeme teate automaatselt 2 sekundi pärast
                            setTimeout(() => {
                                notification.classList.add("hidden");
                            }, 2000);

                            // ✅ Sulgeme modaalakna Alpine.js kaudu
                            setTimeout(() => {
                                const modal = document.querySelector('[x-ref="loginModal"]');
                                if (modal && modal.__x) {
                                    modal.__x.$data.open = false;
                                }
                            }, 100);
                        } catch (error) {
                            alert("Sisselogimine ebaõnnestus: " + error.message);
                        }
                    };
                </script>

                <a href="register.html" id="registerButton"
                    class="save-button bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1 rounded-lg flex items-center justify-center shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-user-plus mr-2"></i> Registreeri
                </a>
                <button id="logoutButton" class="flex items-center gap-2 px-5 py-2 bg-red-500 text-white rounded-full shadow-md transition-all duration-300 
    hover:bg-red-600 hover:shadow-lg hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-red-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1m0-10V7m0 3V6m0 10v-3" />
                    </svg>
                    <span class="text-sm font-medium">Logi välja</span>
                </button>


                <!-- ✅ Dark Mode Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-black-100"></span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggleDarkMode" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 transition-all duration-300">
                        </div>
                        <div
                            class="w-5 h-5 bg-white rounded-full shadow-md absolute left-0.5 top-0.5 peer-checked:translate-x-full transition-transform duration-300">
                        </div>
                    </label>
                    <span class="text-sm text-gray-200"></span>
                </div>
            </nav>
        </div>
    </header>
    <main class="container mx-auto p-6 pt-32">
        </div>
        </div>
        <div id="toolTab" class="flex space-x-4">
            <div class="container bg-white p-6 rounded shadow max-w-lg" id="formContainer">
                <h2 class="text-2xl font-bold text-center mb-4">Riighanke andmed</h2>
                <form id="procurementForm" class="space-y-10">
                    <div>
                        <label for="name" class="block text-gray-700 font-semibold mb-1">Riigihanke nimetus:</label>
                        <input type="text" id="name" name="name" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="cost" class="block text-gray-700 font-semibold mb-1">Riigihanke maksumus:</label>
                        <input type="number" id="cost" name="cost" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="procedureType" class="block text-gray-700 font-semibold mb-1">
                            Riigihanke menetlusliik:
                            <span id="procedureLabel"
                                class="text-gray-500 text-sm roboto opacity-0 transition-opacity duration-300 ml-1"></span>
                        </label>
                        <select id="procedureType" name="procedureType"
                            class="w-full p-2 border rounded bg-white shadow-sm text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            required aria-label="Riigihanke menetlusliik">

                            <!-- Placeholder option (disabled & selected by default) -->
                            <option value="" disabled selected>Vali siit</option>
                            <optgroup label="Avatud hankemenetlus">
                                <option value="Avatud hankemenetlus asjade hankelepingu sõlmimiseks">Asjade hankeleping
                                </option>
                                <option value="Avatud hankemenetlus teenuste hankelepingu sõlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks">Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Piiratud hankemenetlus">
                                <option value="Piiratud hankemenetlus asjade hankelepingu sõlmimiseks">Asjade
                                    hankeleping</option>
                                <option value="Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks">Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Konkurentsipõhine läbirääkimistega menetlus">
                                <option
                                    value="Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks">
                                    Asjade hankeleping</option>
                                <option
                                    value="Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks">
                                    Teenuste hankeleping</option>
                                <option
                                    value="Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks">
                                    Ehitustööde hankeleping</option>
                            </optgroup>

                            <optgroup label="Võistlev dialoog">
                                <option value="Võistlev dialoog asjade hankelepingu sõlmimiseks">Asjade hankeleping
                                </option>
                                <option value="Võistlev dialoog teenuste hankelepingu sõlmimiseks">Teenuste hankeleping
                                </option>
                                <option value="Võistlev dialoog ehitustööde hankelepingu sõlmimiseks">Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Innovatsioonipartnerlus">
                                <option value="Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks">Asjade
                                    hankeleping</option>
                                <option value="Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks">Teenuste
                                    hankeleping</option>
                                <option value="Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks">Ehitustööde
                                    hankeleping</option>
                            </optgroup>

                            <optgroup label="Kontsessioonimenetlus">
                                <option value="Kontsessioonimenetlus koos eraldi taotluse esitamisega">Koos eraldi
                                    taotlusega</option>
                                <option value="Kontsessioonimenetlus ilma eraldi taotlust esitamata">Ilma eraldi
                                    taotluseta</option>
                            </optgroup>

                            <optgroup label="Erimenetlused">
                                <option value="Sotsiaalteenuste erimenetlus">Sotsiaalteenuste erimenetlus</option>
                                <option value="Eriteenuste erimenetlus">Eriteenuste erimenetlus</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label for="contractSigningDate" class="block text-gray-700 font-semibold mb-1">Lepingu
                            allkirjastamise
                            kuupäev:</label>
                        <input type="date" id="contractSigningDate" name="contractSigningDate"
                            class="w-full p-2 border rounded" required>
                    </div>
                    <div class="flex space-x-4 mt-4">
                        <button id="calculateTime"
                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-blue-600 hover:to-blue-700 hover:scale-105 hover:shadow-lg transition-all duration-300">
                            <i class="fas fa-calculator mr-2"></i> Arvuta menetlusaeg
                        </button>
                        <div x-data="{ added: false }" class="relative">
                            <!-- ✅ Lisa hange tabelisse nupp (hidden vaikimisi) -->
                            <button id="updateProcurement" @click="added = true; setTimeout(() => added = false, 2000)"
                                class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 hover:shadow-lg transition-all duration-300 hidden">
                                ✅ Lisa hange tabelisse
                            </button>

                            <!-- ✅ Väike checkmark teade -->
                            <div x-show="added" x-transition.opacity
                                class="absolute mt-2 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md flex items-center">
                                ✅ Lisatud!
                            </div>
                        </div>
                    </div>
                </form>
                <div class="hidden flex space-x-3 mt-6">
                    <button id="clearFields"
                        class="clear-button bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-red-600 hover:to-red-700 hover:scale-105 hover:shadow-lg transition-all duration-300"
                        aria-label="Clear Fields">
                        <i class="fas fa-broom mr-2"></i> Puhasta
                    </button>
                    <button id="saveFields"
                        class="save-button bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 hover:shadow-lg transition-all duration-300"
                        aria-label="Save Fields">
                        <i class="fas fa-save mr-2"></i> Salvesta
                    </button>
                    <button id="refreshFields"
                        class="refresh-button bg-gradient-to-r from-yellow-500 to-yellow-600 text-black px-6 py-3 rounded-lg flex-1 flex items-center justify-center shadow-md hover:from-yellow-600 hover:to-yellow-700 hover:scale-105 hover:shadow-lg transition-all duration-300"
                        aria-label="Refresh Fields">
                        <i class="fas fa-sync-alt mr-2"></i> Uuenda
                    </button>
                </div>
            </div>
            <div class="container bg-white p-6 rounded shadow max-w-xl hidden" id="resultContainer">
                <div id="result" class="result-card"></div>
            </div>
        </div>

        <!-- The saved searches container is hidden by default and will be shown when the user clicks the "Show Saved Searches" button -->
        <div class="container bg-white p-6 rounded-lg shadow-lg hidden" id="savedSearchesContainer">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">📁 Salvestatud Hanked</h2>
            <div class="overflow-x-auto bg-gray-100 p-4 rounded-lg shadow-md">
                <table class="w-full border-collapse shadow-lg rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-left">
                            <th class="p-4">📌 Nimi</th>
                            <th class="p-4">📜 Menetlusliik</th>
                            <th class="p-4">💰 Maksumus (€)</th>
                            <th class="p-4">📅 Taotluse Kuupäev</th>
                            <th class="p-4">🖊️ Allkirjastamise Kuupäev</th>
                            <th class="p-4 text-center">✏️ Muuda</th>
                            <th class="p-4 text-center">❌ Kustuta</th>
                        </tr>
                    </thead>
                    <tbody id="savedSearchesTableBody">
                        <!-- 🔥 Firestore data will be inserted here -->
                    </tbody>
                </table>
                </table>
                <div class="flex gap-4 mt-8 justify-center">
                    <button id="saveToExcel"
                        class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300"
                        aria-label="Save to Excel">
                        📊 Excel
                    </button>
                    <button id="saveToFirestore"
                        class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300">
                        💾 Salvesta
                    </button>
                    <button id="loadFromFirestore"
                        class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-5 py-2 rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 hover:scale-105 transition-all duration-300"
                        aria-label="Load Firestore Data">
                        📂 Näita eelnevaid hankeid
                    </button>
                </div>
            </div>

            <!-- Chart Container (Initially Hidden) -->
            <div id="chartContainer" class="hidden mt-4 w-full max-w-lg mx-auto">
                <canvas id="procurementChart" class="w-full"></canvas>
            </div>
        </div>
        <!-- Settings Container -->
        <div class="flex flex-wrap md:flex-nowrap gap-6 bg-white p-6 rounded-lg shadow-lg max-w-4xl hidden"
            id="settingsContainer" class="adminOnly hidden" aria-hidden="true"> <!-- Hidden by default -->

            <!-- Form Section -->
            <form id="settingsForm" class="flex-1 space-y-6 bg-gray-50 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800">📑 Menetlusliigi sätted</h3>

                <div class="relative">
                    <label for="documentPreparationDays" class="block text-gray-700 mb-1">📄 Riigihanke alusdokumentide
                        koostamine (päevad):</label>
                    <input type="number" id="documentPreparationDays" name="documentPreparationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="offerEvaluationDays" class="block text-gray-700 mb-1">🧐 Pakkumuste hindamine
                        (päevad):</label>
                    <input type="number" id="offerEvaluationDays" name="offerEvaluationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="decisionDays" class="block text-gray-700 mb-1">✅ Vastavaks ja edukaks tunnistamise otsus
                        (päevad):</label>
                    <input type="number" id="decisionDays" name="decisionDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="bidderEvaluationDays" class="block text-gray-700 mb-1">📊 Pakkujate hindamine
                        (päevad):</label>
                    <input type="number" id="bidderEvaluationDays" name="bidderEvaluationDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="successfulBidderDays" class="block text-gray-700 mb-1">🏆 Eduka kõrvaldamata jätmine ja
                        kval (päevad):</label>
                    <input type="number" id="successfulBidderDays" name="successfulBidderDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>

                <div class="relative">
                    <label for="waitingPeriodDays" class="block text-gray-700 mb-1">⏳ Ooteaeg (päevad):</label>
                    <input type="number" id="waitingPeriodDays" name="waitingPeriodDays"
                        class="w-full p-3 border rounded-lg bg-white text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Sisesta päevad" required>
                </div>
            </form>

            <!-- Procedure Type Selection -->
            <div class="flex-1 bg-gray-50 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-bold text-gray-800 mb-3">🛠️ Menetlusliigid</h3>
                <select id="procedureTypeSelect"
                    class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <!-- Options will be populated dynamically -->
                </select>
                <div id="procedureTypeSettings" class="mt-4 space-y-4">
                    <!-- Procedure type settings will be displayed here -->
                </div>
                <button id="addProcedureTypeButton"
                    class="w-full flex items-center justify-center gap-2 mt-4 bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-lg shadow-md hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300">
                    ➕ Lisa Menetlusliik
                </button>
            </div>
        </div>
        </div>
        </div>
        <div class="container bg-white p-6 rounded-lg shadow-lg hidden" id="historyContainer">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">📜 Arvutuste Ajalugu</h2>

            <!-- Filter Dropdown -->
            <div class="mb-4 bg-gray-100 p-4 rounded-lg shadow-md">
                <label for="filterByDate" class="block text-gray-700 font-semibold mb-2">🔎 Filtreeri kuupäeva
                    järgi:</label>
                <select id="filterByDate"
                    class="w-full p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">📅 Kõik kuupäevad</option>
                    <!-- Options will be dynamically added here -->
                </select>
            </div>

            <div class="overflow-x-auto bg-gray-100 p-4 rounded-lg shadow-md">
                <table class="w-full border-collapse shadow-lg rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-gradient-to-r from-blue-500 to-blue-600 text-white text-left">
                            <th class="p-4">📌 Nimi</th>
                            <th class="p-4">📜 Menetlusliik</th>
                            <th class="p-4">💰 Maksumus (€)</th>
                            <th class="p-4">⏳ Menetlusaeg (päevad)</th>
                            <th class="p-4">📅 Taotluse Kuupäev</th>
                            <th class="p-4">🖊️ Allkirjastamise Kuupäev</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History entries will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modern Table -->
        <table id="recentCalculationsTable"
            class="w-full border-collapse shadow-lg rounded-lg overflow-hidden mt-4 hidden">
            <thead class="bg-blue-500 text-white">
                <tr>
                    <th class="p-3">Nimi</th>
                    <th class="p-3">Menetlusliik</th>
                    <th class="p-3">Maksumus</th>
                    <th class="p-3">Menetlusaeg</th>
                    <th class="p-3">Taotluse Kuupäev</th>
                </tr>
            </thead>
            <tbody id="recentCalculations">
                <!-- Last 3 calculations will be dynamically inserted here -->
            </tbody>
        </table>
        <!-- Notification System -->
        <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-md hidden">
            ✅ !
        </div>

        <!-- ✅ Kinnituse modal kustutamiseks -->
        <div id="deleteConfirmModal"
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg w-96 text-center">
                <h2 class="text-xl font-bold mb-4">Kas oled kindel?</h2>
                <p class="text-gray-600 mb-6">Soovid kindlasti kustutada selle riigihanke?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirmDelete"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">Jah</button>
                    <button id="cancelDelete"
                        class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Ei</button>
                </div>
            </div>
        </div>
        <div id="successAlert" role="alert"
            class="alert alert-success fixed top-16 left-1/2 transform -translate-x-1/2 z-50 transition transform scale-95 opacity-0 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none"
                viewBox="0 0 24 24"></svg>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="alertMessage">Andmed salvestatud!</span>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
        <script>

            // kuupäevade handl
            function formatDate(date) {
                if (!date || date === "Määramata") {
                    console.error("❌ Received empty or invalid date:", date);
                    return "Määramata"; // Kasutajasõbralikum väljund
                }

                // 🔹 Kui `date` on string formaadis "dd.mm.yyyy", tagasta see muutmata kujul
                if (typeof date === "string" && date.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                    return date;
                }

                // 🔹 Kui `date` on string formaadis "YYYY-MM-DD", teisenda see "dd.mm.yyyy"
                if (typeof date === "string" && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = date.split("-");
                    return `${day}.${month}.${year}`;
                }

                // 🔹 Kui `date` on Firestore timestamp (Firestore salvestab kuupäevad `toDate()` meetodiga)
                if (typeof date === "object" && date.toDate) {
                    date = date.toDate();
                }

                // 🔹 Kui `date` on juba `Date` objekt, teisenda see stringiks
                if (date instanceof Date && !isNaN(date.getTime())) {
                    return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
                }

                // 🔹 Lõplik kontroll, kas `date` on konverteeritav
                const parsedDate = new Date(date);
                if (isNaN(parsedDate.getTime())) {
                    console.error("❌ Invalid date after parsing:", date);
                    return "Määramata"; // Väldib vigaseid kuupäevi
                }

                return `${String(parsedDate.getDate()).padStart(2, '0')}.${String(parsedDate.getMonth() + 1).padStart(2, '0')}.${parsedDate.getFullYear()}`;
            }

            const procedureData = {
                "Lihthankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 30000 },
                "Lihthankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 30000 },
                "Lihthankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
                "Avatud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
                "Avatud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 15, piirmäär: 60000 },
                "Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 25, piirmäär: 150000 },
                "Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Piiratud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Võistlev dialoog asjade hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Võistlev dialoog teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 15, piirmäär: 60000 },
                "Võistlev dialoog ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 15, pakkumusteAeg: 25, piirmäär: 150000 },
                "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirmäär: 300000 },
                "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 300000 },
                "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 300000 },
                "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 60000 },
            };

            const internationalProcedureData = {
                "Avatud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 143000 },
                "Avatud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 143000 },
                "Avatud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 0, pakkumusteAeg: 45, piirmäär: 5538000 },
                "Piiratud hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Piiratud hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Piiratud hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Konkurentsipõhine läbirääkimistega hankemenetlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Innovatsioonipartnerlus asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Innovatsioonipartnerlus teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Innovatsioonipartnerlus ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Võistlev dialoog asjade hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Võistlev dialoog teenuste hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 143000 },
                "Võistlev dialoog ehitustööde hankelepingu sõlmimiseks": { taotlusteAeg: 30, pakkumusteAeg: 25, piirmäär: 5538000 },
                "Kontsessioonimenetlus koos eraldi taotluse esitamisega": { taotlusteAeg: 30, pakkumusteAeg: 17, piirmäär: 5538000 },
                "Kontsessioonimenetlus ilma eraldi taotlust esitamata": { taotlusteAeg: 0, pakkumusteAeg: 30, piirmäär: 5538000 },
                "Sotsiaalteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 750000 },
                "Eriteenuste erimenetlus": { taotlusteAeg: 0, pakkumusteAeg: 10, piirmäär: 750000 }
            };

            const defaultSettings = {
                documentPreparationDays: 10,
                offerEvaluationDays: 5,
                decisionDays: 3,
                bidderEvaluationDays: 3,
                successfulBidderDays: 3,
                waitingPeriodDays: 14
            };

            let settings = { ...defaultSettings };

            const correctPassword = '123';
            let passwordValidUntil = null;

            function showPasswordPrompt(callback) {
                const now = new Date();
                if (passwordValidUntil && now < passwordValidUntil) {
                    callback();
                    return;
                }

                const passwordPrompt = document.getElementById('passwordPrompt');
                const passwordInput = document.getElementById('passwordInput');
                const passwordError = document.getElementById('passwordError');
                passwordPrompt.classList.remove('hidden');
                passwordInput.value = '';
                passwordError.classList.add('hidden');

                document.getElementById('passwordSubmit').onclick = function () {
                    if (passwordInput.value === correctPassword) {
                        passwordPrompt.classList.add('hidden');
                        passwordValidUntil = new Date(now.getTime() + 10 * 60000); // 10 minutes from now
                        callback();
                    } else {
                        passwordError.classList.remove('hidden');
                    }
                };

                document.getElementById('passwordClose').onclick = function () {
                    passwordPrompt.classList.add('hidden');
                };
            }

            document.getElementById("calculateTime").addEventListener("click", function () {
                // ✅ Kontrollime, kas kõik väljad on täidetud
                const name = document.getElementById("name").value.trim();
                const cost = document.getElementById("cost").value.trim();
                const procedureType = document.getElementById("procedureType").value.trim();
                const contractSigningDate = document.getElementById("contractSigningDate").value.trim();

                if (!name || !cost || !procedureType || !contractSigningDate) {
                    alert("Palun täida kõik väljad enne arvutamist!");
                    return;
                }

                // ✅ Kuvame "Lisa hange tabelisse" nupu
                document.getElementById("updateProcurement").classList.remove("hidden");
            });

            document.getElementById('settingsButton').addEventListener('click', function () {
                closeAllTabs();
                document.getElementById('settingsContainer').classList.remove('hidden');
                loadSettings();
                loadProcedureTypes();
                setActiveTab(this);
            });

            document.getElementById("adminTab").addEventListener("click", () => {
                window.location.href = "/admin.html"; // Redirect to the admin page
            });

            document.getElementById('settingsForm').addEventListener('submit', function (event) {
                event.preventDefault();
                settings.documentPreparationDays = parseInt(document.getElementById('documentPreparationDays').value);
                settings.offerEvaluationDays = parseInt(document.getElementById('offerEvaluationDays').value);
                settings.decisionDays = parseInt(document.getElementById('decisionDays').value);
                settings.bidderEvaluationDays = parseInt(document.getElementById('bidderEvaluationDays').value);
                settings.successfulBidderDays = parseInt(document.getElementById('successfulBidderDays').value);
                settings.waitingPeriodDays = parseInt(document.getElementById('waitingPeriodDays').value);
            });

            document.getElementById('addProcedureTypeButton').addEventListener('click', function () {
                addProcedureType();
            });

            document.getElementById('procedureTypeSelect').addEventListener('change', function () {
                const selectedType = this.value;
                loadProcedureTypeSettings(selectedType);
            });

            function loadSettings() {
                document.getElementById('documentPreparationDays').value = settings.documentPreparationDays;
                document.getElementById('offerEvaluationDays').value = settings.offerEvaluationDays;
                document.getElementById('decisionDays').value = settings.decisionDays;
                document.getElementById('bidderEvaluationDays').value = settings.bidderEvaluationDays;
                document.getElementById('successfulBidderDays').value = settings.successfulBidderDays;
                document.getElementById('waitingPeriodDays').value = settings.waitingPeriodDays;
            }

            function saveSettings() {
                localStorage.setItem('procurementSettings', JSON.stringify(settings));
            }

            function loadSavedSettings() {
                const savedSettings = localStorage.getItem('procurementSettings');
                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                }
            }

            function loadProcedureTypes() {
                const select = document.getElementById('procedureTypeSelect');
                select.innerHTML = '';
                Object.keys(procedureData).forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
                if (select.options.length > 0) {
                    loadProcedureTypeSettings(select.options[0].value);
                }
            }

            function loadProcedureTypeSettings(type) {
                const procedure = procedureData[type];
                const container = document.getElementById('procedureTypeSettings');
                container.innerHTML = `
            <div class="procedure-type">
                <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                <input type="text" id="procedureTypeName" value="${type}" required><br><br>
                <label for="requestDays" class="block text-gray-700">Taotluste esitamise päevad:</label>
                <input type="number" id="requestDays" value="${procedure.taotlusteAeg}" required><br><br>
                <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise päevad:</label>
                <input type="number" id="offerDays" value="${procedure.pakkumusteAeg}" required><br><br>
                <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi tähtaegu:</label>
                <input type="checkbox" id="useInternationalThreshold" ${procedure.useInternational ? 'checked' : ''} onchange="toggleInternationalThreshold('${type}')"><br><br>
                <button onclick="deleteProcedureType('${type}')" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition transform hover:scale-105">Kustuta</button>
                <button onclick="saveProcedureType('${type}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
            </div>
            `;
            }

            function addProcedureType() {
                const container = document.getElementById('procedureTypeSettings');
                container.innerHTML = `
            <div class="procedure-type">
                <label for="procedureTypeName" class="block text-gray-700">Menetlusliik:</label>
                <input type="text" id="procedureTypeName" required><br><br>
                <label for="requestDays" class="block text-gray-700">Taotluste esitamise päevad:</label>
                <input type="number" id="requestDays" required><br><br>
                <label for="offerDays" class="block text-gray-700">Pakkumuste esitamise päevad:</label>
                <input type="number" id="offerDays" required><br><br>
                <label for="useInternationalThreshold" class="block text-gray-700">Kasuta rahvusvahelisi tähtaegu:</label>
                <input type="checkbox" id="useInternationalThreshold" onchange="toggleInternationalThreshold()"><br><br>
                <button onclick="saveNewProcedureType()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition transform hover:scale-105">Salvesta</button>
            </div>
            `;
            }

            function toggleInternationalThreshold(type) {
                const useInternational = document.getElementById('useInternationalThreshold').checked;
                const procedure = useInternational ? internationalProcedureData[type] : procedureData[type];
                document.getElementById('requestDays').value = procedure.taotlusteAeg;
                document.getElementById('offerDays').value = procedure.pakkumusteAeg;
            }

            function deleteProcedureType(type) {
                delete procedureData[type];
                loadProcedureTypes();
                saveSettings();
            }

            function saveProcedureType(oldType) {
                const newType = document.getElementById('procedureTypeName').value;
                const requestDays = parseInt(document.getElementById('requestDays').value);
                const offerDays = parseInt(document.getElementById('offerDays').value);
                const useInternational = document.getElementById('useInternationalThreshold').checked;
                delete procedureData[oldType];
                procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirmäär: 60000, useInternational }; // Default piirmäär
                loadProcedureTypes();
                saveSettings();
            }

            function saveNewProcedureType() {
                const newType = document.getElementById('procedureTypeName').value;
                const requestDays = parseInt(document.getElementById('requestDays').value);
                const offerDays = parseInt(document.getElementById('offerDays').value);
                const useInternational = document.getElementById('useInternationalThreshold').checked;
                procedureData[newType] = { taotlusteAeg: requestDays, pakkumusteAeg: offerDays, piirmäär: 60000, useInternational }; // Default piirmäär
                loadProcedureTypes();
                saveSettings();
            }

            loadSavedSettings();

            class PublicProcurement {
                constructor(name, cost, procedureType, contractSigningDate) {
                    // Ensure the date is valid before any conversion logic
                    if (!contractSigningDate || isNaN(new Date(contractSigningDate).getTime())) {
                        console.error("Invalid contract signing date:", contractSigningDate);
                        this.contractSigningDate = null; // Avoid breaking further calculations
                    } else {
                        // Convert dd.mm.yyyy to YYYY-MM-DD if necessary
                        if (typeof contractSigningDate === "string" && contractSigningDate.includes(".")) {
                            const parts = contractSigningDate.split(".");
                            if (parts.length === 3) {
                                contractSigningDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                        }
                        this.contractSigningDate = new Date(contractSigningDate);
                    }

                    this.name = name;
                    this.cost = cost;
                    this.procedureType = procedureType;
                    this.contractSigningDate = new Date(contractSigningDate); null;
                    this.procedureDuration = this.calculateProcedureDuration();
                    this.procedureDetails = this.calculateProcedureDetails();
                    this.requestSubmissionDate = this.calculateRequestSubmissionDate();
                }

                calculateProcedureDuration() {
                    const procedure = procedureData[this.procedureType];
                    const internationalProcedure = internationalProcedureData[this.procedureType];
                    const internationalThreshold = internationalProcedure.piirmäär;

                    let duration = 0;

                    if (this.cost > internationalThreshold || procedure.useInternational) {
                        duration += internationalProcedure.taotlusteAeg + internationalProcedure.pakkumusteAeg;
                    } else {
                        duration += procedure.taotlusteAeg + procedure.pakkumusteAeg;
                    }

                    duration += settings.documentPreparationDays;
                    duration += settings.offerEvaluationDays;
                    duration += settings.decisionDays;
                    duration += settings.bidderEvaluationDays;
                    duration += settings.successfulBidderDays;
                    duration += settings.waitingPeriodDays;

                    return duration;
                }

                calculateProcedureDetails() {
                    const procedure = procedureData[this.procedureType];
                    const internationalProcedure = internationalProcedureData[this.procedureType];
                    const internationalThreshold = internationalProcedure.piirmäär;
                    let taotlusteAeg, pakkumusteAeg;

                    if (this.cost > internationalThreshold || procedure.useInternational) {
                        taotlusteAeg = internationalProcedure.taotlusteAeg;
                        pakkumusteAeg = internationalProcedure.pakkumusteAeg;
                    } else {
                        taotlusteAeg = procedure.taotlusteAeg;
                        pakkumusteAeg = procedure.pakkumusteAeg;
                    }

                    const details = [
                        { step: "Riigihanke alusdokumentide koostamine", days: ` ${settings.documentPreparationDays} päeva` },
                        { step: "Taotluste esitamine RHRis", days: taotlusteAeg ? `${taotlusteAeg} päeva` : "Ei kohaldu" },
                        { step: "Pakkumuste esitamine RHRis", days: pakkumusteAeg ? `${pakkumusteAeg} päeva` : "Ei kohaldu" },
                        { step: "Hindamine 1", days: `${settings.offerEvaluationDays} päeva` },
                        { step: "Otsus 1", days: `${settings.decisionDays} päeva` },
                        { step: "Hindamine 2", days: `${settings.bidderEvaluationDays} päeva` },
                        { step: "Otsus 2", days: `${settings.successfulBidderDays} päeva` },
                        { step: "Ooteaeg", days: `${settings.waitingPeriodDays} päeva` }
                    ];
                    return details;
                }

                calculateRequestSubmissionDate() {
                    // Step 1: Ensure contractSigningDate is in YYYY-MM-DD format
                    if (typeof this.contractSigningDate === "string" && this.contractSigningDate.includes(".")) {
                        const parts = this.contractSigningDate.split(".");
                        if (parts.length === 3) {
                            this.contractSigningDate = typeof this.contractSigningDate === "string" ? `${parts[2]}-${parts[1]}-${parts[0]}` : this.contractSigningDate; // Convert dd.mm.yyyy → YYYY-MM-DD only if it's a string
                        }
                    }

                    // Step 2: Validate contractSigningDate before using it
                    if (!this.contractSigningDate || isNaN(new Date(this.contractSigningDate).getTime())) {
                        console.error("Invalid contract signing date:", this.contractSigningDate);
                        return "Invalid date"; // Prevent further errors
                    }

                    // Step 3: Calculate the request submission date
                    const submissionDate = new Date(this.contractSigningDate);
                    if (!isNaN(this.procedureDuration)) {
                        submissionDate.setDate(submissionDate.getDate() - this.procedureDuration);
                        if (isNaN(submissionDate.getTime())) {
                            console.error("Invalid submission date:", submissionDate);
                            return "Invalid date"; // Prevents errors
                        }
                        return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
                        console.error("Invalid procedure duration:", this.procedureDuration);
                    }

                    // Step 4: Calculate expected quarter
                    const month = submissionDate.getMonth() + 1;
                    const year = submissionDate.getFullYear();
                    this.expectedQuarter = `Q${Math.ceil(month / 3)} ${year}`;

                    return submissionDate.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
                }

                generateHTML() {
                    const detailsHTML = this.procedureDetails.map((detail, index) => `
                    <li class="flex flex-col py-2 border-b">
                        <div class="flex justify-between items-center">
                            <span class="w-3/4">${detail.step}:</span>
                            <span id="days-${index}" class="w-16 text-center font-medium whitespace-nowrap">${detail.days}</span>
                            <div class="flex gap-1 ml-6">
                                <button onclick="adjustDays(${index}, -1)" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition transform hover:scale-105">-</button>
                                <button onclick="adjustDays(${index}, 1)" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition transform hover:scale-105">+</button>
                            </div>
                        </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mt-1">
                            <div id="progress-${index}" class="progress-bar bg-blue-500 h-4 rounded-full transition-all duration-500" data-progress="0"></div>
                        </div>
                    </li>
                `).join('');

                    const errorMessage = new Date(this.requestSubmissionDate) < new Date() ?
                        '<p class="error-message text-red-500 font-bold">NB! Oled hiljaks jäänud planeerimisel!</p>' : '';

                    return `
                    <div class="result-card bg-white p-6 rounded max-w-lg">
                        <h2 class="text-2xl font-bold text-black-500 mb-4">Riigihanke andmed</h2>
                        <p><strong>Riigihanke taotluse esitamise kuupäev:</strong> 
                            <span id="requestSubmissionDate">${formatDate(this.requestSubmissionDate)}</span>
                        </p>
                        ${errorMessage}
                        <p><strong>Nimi:</strong> ${this.name}</p>
                        <p><strong>Maksumus:</strong> ${this.cost}</p>
                        <p><strong>Riigihanke menetlusliik:</strong> ${this.procedureType}</p>
                        <p><strong>Lepingu allkirjastamise kuupäev:</strong> ${formatDate(this.contractSigningDate)}</p>

                        <p><strong>Eeldatav riigihanke menetlusaeg päevades:</strong> <span id="totalDuration">${this.procedureDuration}</span> päeva</p>

                        <ul class="list-none p-0">
                            ${detailsHTML}
                        </ul>
                    </div>
                `;
                    return html;
                }

                generateTableRow(index) {
                    return `
                    <tr>
                        <td class="border p-2">${this.name}</td>
                        <td class="border p-2">${this.procedureType}</td>
                        <td class="border p-2">${this.expectedQuarter}</td>
                        <td class="border p-2">${this.cost}</td>
                        <td class="border p-2">${this.procedureDuration} päeva</td>
                        <td class="border p-2">${formatDate(this.requestSubmissionDate)}</td>
                        <td class="border p-2">${formatDate(this.contractSigningDate)}</td>
                        <td class="border p-2"><button class="edit-button bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 transition transform hover:scale-105" onclick="editSearch(${index})">Muuda</button></td>
                        <td class="border p-2"><button class="delete-button bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition transform hover:scale-105" onclick="deleteSearch(${index})">Kustuta</button></td>
                    </tr>
                `;
                }
            }

            function adjustDays(index, adjustment) {
                const daysElement = document.getElementById(`days-${index}`);
                if (!daysElement) {
                    console.error(`❌ Element with id days-${index} not found`);
                    return;
                }

                let days = parseInt(daysElement.innerText.match(/\d+/)?.[0] || "0", 10);
                days = Math.max(0, days + adjustment);
                daysElement.innerText = `${days} päeva`;

                // ✅ Uuendame menetluse kogukestust
                const totalDurationElement = document.getElementById('totalDuration');
                if (totalDurationElement) {
                    let totalDuration = parseInt(totalDurationElement.innerText || "0", 10);
                    totalDuration = Math.max(0, totalDuration + adjustment);
                    totalDurationElement.innerText = totalDuration;
                } else {
                    console.error("❌ Element with id totalDuration not found");
                }

                // ✅ Otsime hanke nime järgi
                let procurement = savedSearches.find(p => p.name === document.getElementById('name').value.trim());

                // 🔹 Kui hanget pole, loome uue ja lisame massiivi
                if (!procurement) {
                    console.warn("⚠ Hange ei ole massiivis, loon uue objekti.");

                    procurement = new PublicProcurement(
                        document.getElementById('name').value.trim(),
                        parseFloat(document.getElementById('cost').value),
                        document.getElementById('procedureType').value,
                        document.getElementById('contractSigningDate').value
                    );
                    savedSearches.push(procurement);
                }

                // ✅ Veendume, et menetluse kestus ja taotluse esitamise kuupäev uuenevad õigesti
                procurement.procedureDuration = parseInt(totalDurationElement.innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                if (!procurement.requestSubmissionDate || procurement.requestSubmissionDate === "Invalid date") {
                    console.error("❌ Arvutatud kuupäev on vigane:", procurement.requestSubmissionDate);
                    procurement.requestSubmissionDate = "Määramata";
                }

                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);

                // ✅ Uuendame tabelis kuvamist ja progressiribasid
                updateSavedSearchesTable();
                updateTotalDuration();
                updateProgressBars();
            }

            const savedSearches = [];
            const history = [];

            document.getElementById('procurementForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                const name = document.getElementById('name').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const procedureType = document.getElementById('procedureType').value;
                const contractSigningDate = document.getElementById('contractSigningDate').value;

                const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                document.getElementById('result').innerHTML = procurement.generateHTML();

                // ✅ Progressi ja kestuse uuendamine
                setTimeout(() => {
                    updateTotalDuration();
                    updateProgressBars();
                }, 100);

                // ✅ Kuvame tulemuste konteineri
                document.getElementById('resultContainer').classList.remove('hidden');
            });

            document.getElementById("updateProcurement").addEventListener("click", function () {
                const name = document.getElementById('name').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const procedureType = document.getElementById('procedureType').value;
                const contractSigningDate = document.getElementById('contractSigningDate').value;
                const requestSubmissionDate = document.getElementById('requestSubmissionDate').innerText;

                if (!name || isNaN(cost) || !procedureType || !contractSigningDate || requestSubmissionDate === "Määramata") {
                    alert("Palun täida kõik väljad!");
                    return;
                }

                const index = savedSearches.findIndex(search => search.name === name);
                if (index !== -1) {
                    savedSearches.splice(index, 1);
                }

                let procurement = {
                    name,
                    cost,
                    procedureType,
                    contractSigningDate,
                    requestSubmissionDate,
                };

                savedSearches.push(procurement);
                updateSavedSearchesTable();

                console.log("✅ Hange lisatud tabelisse, kuid mitte Firestore'i:", procurement);
            });

            document.getElementById('clearFields').addEventListener('click', function () {
                document.getElementById('procurementForm').reset();
                document.getElementById('result').innerHTML = '';
                document.getElementById('resultContainer').classList.add('hidden'); // Hide the result container
            });

            document.getElementById('saveFields').addEventListener('click', function () {
                const name = document.getElementById('name').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const procedureType = document.getElementById('procedureType').value;
                const contractSigningDate = document.getElementById('contractSigningDate').value;

                const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);

                // Update procedure details with adjusted days
                procurement.procedureDetails.forEach((detail, index) => {
                    const daysElement = document.getElementById(`days-${index}`);
                    if (daysElement) {
                        let daysText = daysElement.innerText;
                        let match = daysText.match(/\d+/);
                        if (match) {
                            let days = parseInt(match[0]);
                            detail.days = `${days} päeva`;
                        } else {
                            console.error("No days found in text:", daysText);
                        }
                    } else {
                        console.error("Element not found for index:", index);
                    }
                })

                // Capture the adjusted procedureDuration value
                const totalDurationElement = document.getElementById('totalDuration');
                if (totalDurationElement) {
                    procurement.procedureDuration = parseInt(totalDurationElement.innerText);
                } else {
                    console.error("Total duration element not found");
                }

                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                // Update the displayed result
                document.getElementById('result').innerHTML = procurement.generateHTML();

                // Save the updated procurement
                const existingIndex = savedSearches.findIndex(p => p.name === name);
                if (existingIndex !== -1) {
                    savedSearches[existingIndex] = procurement;
                } else {
                    if (savedSearches.length < 15) {
                        savedSearches.push(procurement);
                    } else {
                        alert("Maksimaalne salvestatud otsingute arv on 15.");
                    }
                }
            });

            document.getElementById('refreshFields').addEventListener('click', function () {
                const procurement = new PublicProcurement(
                    document.getElementById('name').value,
                    parseFloat(document.getElementById('cost').value),
                    document.getElementById('procedureType').value,
                    document.getElementById('contractSigningDate').value
                );

                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
                updateSavedSearchesTable();
            });

            document.getElementById('saveToExcel').addEventListener('click', function () {
                if (savedSearches.length === 0) {
                    alert("Salvestatud otsinguid ei ole.");
                    return;
                }

                // Define column headers
                const headers = [
                    "Riigihanke Eseme Nimetus",
                    "Riigihanke Menetluse Liik",
                    "Riigihanke Korraldamise Eeldatav Aeg",
                    "Riigihanke Eeldatav Maksumus (ilma KM-ta)",
                    "Sõlmitava Lepingu Kehtivusaeg",
                    "Riigihanke Eest Vastutav Isik",
                    "Tehnilise Kirjelduse Eest Vastutav Isik"
                ];

                // Prepare data rows
                const data = savedSearches.map(procurement => [
                    procurement.name || "",
                    procurement.procedureType || "",
                    getQuarter(procurement.applicationDate || "Määramata"),
                    procurement.cost || "",
                    "",  // Empty field for contract duration
                    "",  // Empty field for responsible person
                    ""   // Empty field for technical responsible person
                ]);

                // Combine headers and data
                const worksheetData = [headers, ...data];

                // Create a new workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(worksheetData);

                // Auto-width for columns
                ws['!cols'] = headers.map(() => ({ wch: 25 }));

                // Apply table formatting
                const range = XLSX.utils.decode_range(ws['!ref']);
                ws['!autofilter'] = { ref: XLSX.utils.encode_range(range) };

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "Hankeplaan");

                // Export to .xlsx file
                XLSX.writeFile(wb, "hankeplaan.xlsx");
            });

            const getQuarter = (dateString) => {
                if (!dateString || dateString === "Määramata") return "Määramata"; // If no date, return "Määramata"

                const dateParts = dateString.split('.');
                if (dateParts.length !== 3) return "Määramata"; // Expecting "dd.mm.yyyy" format

                const month = parseInt(dateParts[1], 10);
                const year = dateParts[2];

                if (month >= 1 && month <= 3) return `1. kvartal ${year}`;
                if (month >= 4 && month <= 6) return `2. kvartal ${year}`;
                if (month >= 7 && month <= 9) return `3. kvartal ${year}`;
                if (month >= 10 && month <= 12) return `4. kvartal ${year}`;

                return "Määramata"; // Ensure a valid return value
            };
            // ✅ Defineerime muutuja üleval, et vältida "not defined" viga
            let resultContainerHTML = "";

            document.getElementById("showSavedSearches").addEventListener("click", function () {
                // ✅ Salvestame resultContainer sisu enne selle peitmist
                resultContainerHTML = document.getElementById("resultContainer").innerHTML;
                document.getElementById("resultContainer").classList.add("hidden");
            });

            document.getElementById("showForm").addEventListener("click", function () {
                // ✅ Kui resultContainerHTML on olemas, taastame selle
                if (resultContainerHTML) {
                    document.getElementById("resultContainer").innerHTML = resultContainerHTML;
                    document.getElementById("resultContainer").classList.remove("hidden");
                }
                setActiveTab(this);
            });

            document.getElementById('showSavedSearches').addEventListener('click', function () {
                saveResultContainerHTML();
                closeAllTabs();
                document.getElementById('savedSearchesContainer').classList.remove('hidden');
                updateSavedSearchesTable();
                setActiveTab(this);
            });

            document.getElementById('settingsButton').addEventListener('click', function () {
                saveResultContainerHTML();
                closeAllTabs();
                document.getElementById('settingsContainer').classList.remove('hidden');
                loadSettings();
                loadProcedureTypes();
                setActiveTab(this);
            });

            function setActiveTab(button) {
                const navButtons = document.querySelectorAll('.nav button');
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            }

            function saveResultContainerHTML() {
                resultContainerHTML = document.getElementById('resultContainer').innerHTML;
            }

            function closeAllTabs() {
                document.getElementById('formContainer').classList.add('hidden');
                document.getElementById('savedSearchesContainer').classList.add('hidden');
                document.getElementById('settingsContainer').classList.add('hidden');
                document.getElementById('resultContainer').classList.add('hidden');
            }

            function updateSavedSearchesTable() {
                const tableBody = document.getElementById("savedSearchesTableBody");
                tableBody.innerHTML = ""; // Puhastame tabeli

                savedSearches.forEach((search, index) => {
                    const row = `
        <tr class="border-b even:bg-gray-100 hover:bg-gray-200 transition-all">
            <td class="p-4">${search.name}</td>
            <td class="p-4">${search.procedureType}</td>
            <td class="p-4">${search.cost} €</td>
            <td class="p-4 text-blue-600 font-semibold">${formatDate(search.requestSubmissionDate || "Määramata")}</td>
            <td class="p-4 text-gray-500">${formatDate(search.contractSigningDate)}</td>
            <td class="p-4 text-center">
                <button onclick="editSearch(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105">
                ✏️ Muuda
                </button>
            </td>
            <td class="p-4 text-center">
                <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">
                ❌ Kustuta
                </button>
            </td>
        </tr>
        `;
                    tableBody.innerHTML += row;
                });
            }
            let deleteIndex = null; // Hoiab ajutiselt indeksi, mida kustutada soovitakse

            async function deleteSearch(index) {
                deleteIndex = index; // Salvestame kustutatava indeksi
                document.getElementById("deleteConfirmModal").classList.remove("hidden"); // Kuvame modali
            }


            async function updateProcurementInFirestore() {
                const user = auth.currentUser;
                if (!user) {
                    alert("Salvestamiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        console.error("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        return;
                    }

                    let searches = userDoc.data().searches || [];
                    const procurementName = document.getElementById('name').value;
                    const searchIndex = searches.findIndex(s => s.name === procurementName);

                    if (searchIndex === -1) {
                        console.warn("⚠ Firestore'is ei leitud vastavat hanget, ei saa uuendada.");
                        return;
                    }

                    // ✅ Kontrollime ja teisendame kuupäeva õigesse formaati (YYYY-MM-DD)
                    let newRequestDate = document.getElementById('requestSubmissionDate').innerText.trim();

                    console.log("🟡 Kontrollime kuupäeva enne teisendamist:", newRequestDate);

                    if (!newRequestDate || newRequestDate === "Määramata") {
                        console.error("❌ Vigane kuupäev, ei saa Firestore'i salvestada:", newRequestDate);
                        newRequestDate = "Määramata"; // Kui puudub, määrame vaikimisi
                    } else if (newRequestDate.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
                        // Kui kuupäev on "dd.mm.yyyy", teisendame selle "yyyy-mm-dd"
                        const [day, month, year] = newRequestDate.split(".");
                        newRequestDate = `${year}-${month}-${day}`;
                    }

                    console.log("✅ Teisendatud kuupäev Firestore'i salvestamiseks:", newRequestDate);

                    // ✅ Uuendame kirje Firestore'is
                    searches[searchIndex].procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                    searches[searchIndex].requestSubmissionDate = newRequestDate;

                    await updateDoc(userDocRef, { searches });

                    console.log("✅ Hange Firestore'is uuendatud:", searches[searchIndex]);

                } catch (error) {
                    console.error("❌ Firestore'i uuendamise viga:", error);
                }
            }

            document.getElementById("confirmDelete").addEventListener("click", async () => {
                if (deleteIndex === null) return; // Kui indeks puudub, ära tee midagi

                const user = auth.currentUser;
                if (!user) {
                    alert("Kustutamiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        console.error("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        return;
                    }

                    let searches = userDoc.data().searches || [];

                    if (deleteIndex < 0 || deleteIndex >= searches.length) {
                        console.error("❌ Kehtetu indeks:", deleteIndex);
                        return;
                    }

                    const searchToDelete = searches[deleteIndex];

                    console.log("🔴 Enne kustutamist:", searches);
                    console.log("🚨 Kustutame:", searchToDelete);

                    // 🔥 Kustutame Firestore'ist ainult selle konkreetse objekti
                    await updateDoc(userDocRef, {
                        searches: searches.filter((_, i) => i !== deleteIndex)
                    });

                    console.log("✅ Otsing kustutatud Firestore'ist:", searchToDelete);

                    // 🕒 Lisame animatsiooni ja eemaldame rea tabelist
                    const tableBody = document.getElementById("savedSearchesTableBody");
                    const rowToRemove = tableBody.children[deleteIndex];

                    if (rowToRemove) {
                        rowToRemove.classList.add("fade-out"); // Lisame CSS animatsiooni
                        setTimeout(() => rowToRemove.remove(), 500); // Eemaldame rea pärast animatsiooni
                    }

                    deleteIndex = null; // Nullime indeksi pärast kustutamist
                    document.getElementById("deleteConfirmModal").classList.add("hidden"); // Sulgeme modali

                } catch (error) {
                    console.error("❌ Firestore'i kustutamise viga:", error);
                }
            });

            document.getElementById("cancelDelete").addEventListener("click", () => {
                deleteIndex = null; // Tühistame kustutamise
                document.getElementById("deleteConfirmModal").classList.add("hidden"); // Peidame modali
            });

            function editSearch(index) {
                const procurement = savedSearches[index];
                document.getElementById('name').value = procurement.name;
                document.getElementById('cost').value = procurement.cost;
                document.getElementById('procedureType').value = procurement.procedureType;
                document.getElementById('contractSigningDate').value = procurement.contractSigningDate.toISOString().split('T')[0];
                deleteSearch(index);
                closeAllTabs();
                document.getElementById('formContainer').classList.remove('hidden');
                setActiveTab(document.getElementById('showForm'));
            }

            function refreshDuration(index) {
                const procurement = savedSearches[index];
                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
                updateSavedSearchesTable();
            }

            function updateHistoryTable() {
                const tableBody = document.getElementById('historyTableBody');
                tableBody.innerHTML = '';
                history.forEach((procurement, index) => {
                    console.log('Adding row for:', procurement); // Debugging statement
                    tableBody.innerHTML += procurement.generateTableRow(index);
                });
                populateFilterOptions();
            }

            function populateFilterOptions() {
                const filterSelect = document.getElementById('filterByDate');
                const dates = [...new Set(history.map(procurement => procurement.contractSigningDate.toISOString().split('T')[0]))];
                filterSelect.innerHTML = '<option value="all">Kõik</option>';
                dates.forEach(date => {
                    filterSelect.innerHTML += `<option value="${date}">${date}</option>`;
                });
            }

            document.getElementById('filterByDate').addEventListener('change', function () {
                const selectedDate = this.value;
                const filteredHistory = selectedDate === 'all' ? history : history.filter(procurement => procurement.contractSigningDate.toISOString().split('T')[0] === selectedDate);
                const tableBody = document.getElementById('historyTableBody');
                tableBody.innerHTML = '';
                filteredHistory.forEach((procurement, index) => {
                    tableBody.innerHTML += procurement.generateTableRow(index);
                });
            });

            async function saveToFirestore(index) {
                const user = auth.currentUser;
                if (!user) {
                    alert("Salvestamiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    let searches = userDoc.exists() ? userDoc.data().searches || [] : [];

                    searches.push(savedSearches[index]);

                    await updateDoc(userDocRef, { searches });

                    console.log("✅ Hange Firestore'is salvestatud:", savedSearches[index]);
                    showNotification("✅ Andmed salvestatud!");
                } catch (error) {
                    console.error("❌ Firestore'i salvestamise viga:", error);
                }
            }

            // ✅ Firestore'st andmete laadimise funktsioon
            async function loadUserSearches() {
                const user = auth.currentUser;
                if (!user) {
                    console.error("❌ Kasutajat ei leitud, ei saa otsinguid laadida.");
                    return;
                }

                try {
                    console.log("📥 Laen Firestore'ist salvestatud otsinguid...");
                    const userDoc = await getDoc(doc(db, "users", user.uid));

                    if (!userDoc.exists()) {
                        console.warn("⚠ Kasutajal pole salvestatud hankeid Firestore'is.");
                        return;
                    }

                    let searches = userDoc.data().searches || [];
                    console.log("📜 Laetud otsingud Firestore'ist:", searches);

                    // ✅ Teisendame kuupäevad õigesse formaati
                    searches = searches.map(search => ({
                        ...search,
                        requestSubmissionDate: formatDate(search.requestSubmissionDate || "Määramata"),
                        contractSigningDate: formatDate(search.contractSigningDate || "Määramata")
                    }));

                    displaySearches(searches); // ✅ Uuendame tabeli
                } catch (error) {
                    console.error("❌ Otsingute laadimise viga Firestore'ist:", error);
                }
            }

            document.getElementById('toggleDarkMode').addEventListener('click', function () {
                document.body.classList.toggle('bg-gray-900');
                document.body.classList.toggle('text-white');
            });

            function adjustTableColumns() {
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    const columns = table.querySelectorAll('th');
                    columns.forEach((column, index) => {
                        let maxWidth = 0;
                        const cells = table.querySelectorAll(`td:nth-child(${index + 1})`);
                        cells.forEach(cell => {
                            const cellWidth = cell.offsetWidth;
                            if (cellWidth > maxWidth) {
                                maxWidth = cellWidth;
                            }
                        });
                        column.style.width = `${maxWidth}px`;
                    });
                });
            }

            document.getElementById('dropdownButton').addEventListener('click', function () {
                const dropdownMenu = document.getElementById('dropdownMenu');
                dropdownMenu.classList.toggle('hidden');
            });

            document.addEventListener('click', function (event) {
                const dropdownButton = document.getElementById('dropdownButton');
                const dropdownMenu = document.getElementById('dropdownMenu');
                if (!dropdownButton.contains(event.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });

            // Dark Mode Toggle
            const darkModeToggle = document.getElementById('toggleDarkMode');
            darkModeToggle.addEventListener('change', () => {
                document.body.classList.toggle('bg-gray-900');
                document.body.classList.toggle('text-white');

                // Navbar, header, and tab menu
                // Fix navbar & header gradient
                const header = document.querySelector('header');
                if (darkModeToggle.checked) {
                    header.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600');
                    header.classList.add('bg-gray-800');
                } else {
                    header.classList.remove('bg-gray-800');
                    header.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600');
                }

                // Ensure navbar links stay visible
                document.querySelectorAll('nav a').forEach(el => {
                    el.classList.toggle('text-gray-300');
                    el.classList.toggle('text-white');
                });

                document.querySelectorAll('header, nav, .tab-content').forEach(el => {
                    el.classList.toggle('bg-gray-800');
                    el.classList.toggle('text-white');
                });

                // Containers & content boxes
                document.querySelectorAll('.container, .shadow, .rounded-lg, .bg-white, .bg-gray-100, .bg-gray-50').forEach(el => {
                    el.classList.toggle('bg-gray-800');
                    el.classList.toggle('text-gray-200');
                });

                // Tables
                document.querySelectorAll('table').forEach(el => {
                    el.classList.toggle('bg-gray-700');
                    el.classList.toggle('text-gray-300');
                });

                // Table headers
                document.querySelectorAll('thead tr').forEach(el => {
                    el.classList.toggle('bg-gray-600');
                });

                // Buttons
                document.querySelectorAll('button').forEach(el => {
                    el.classList.toggle('shadow-lg');
                    el.classList.toggle('border-gray-700');
                });

                // Form Inputs & Select Boxes
                document.querySelectorAll('input, select, textarea').forEach(el => {
                    el.classList.toggle('bg-gray-700');
                    el.classList.toggle('text-white');
                    el.classList.toggle('border-gray-600');
                });

                // Save dark mode preference in localStorage
                if (document.body.classList.contains('bg-gray-900')) {
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            // Show Notification
            function showNotification(message, duration = 3000) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, duration);
            }

            document.getElementById('saveFields').addEventListener('click', function () {
                // Your save logic here
                showNotification('Salvestatud edukalt!');
            });

            document.getElementById('refreshFields').addEventListener('click', function () {
                // Your update logic here
                showNotification('Uuendatud edukalt!');
            });

            function toggleChart() {
                const chartContainer = document.getElementById("chartContainer");
                chartContainer.classList.toggle("hidden");

                // Ensure table has data before rendering
                if (!chartContainer.classList.contains("hidden")) {
                    setTimeout(() => {
                        if (document.querySelectorAll("#savedSearchesTableBody tr").length > 0) {
                            renderChart();
                        } else {
                            console.warn("⚠ No saved searches found, chart cannot be displayed.");
                        }
                    }, 300);
                }
            }

            function renderChart() {
                const canvas = document.getElementById("procurementChart");
                if (!canvas) {
                    console.error("❌ Chart canvas not found!");
                    return;
                }

                const ctx = canvas.getContext("2d");

                // Destroy previous chart if it exists
                if (window.procurementChart && typeof window.procurementChart.destroy === 'function') {
                    window.procurementChart.destroy();
                }

                // Extract data from savedSearchesTableBody
                const rows = document.querySelectorAll("#savedSearchesTableBody tr");
                const labels = [];
                const costs = [];
                const totalDays = [];

                rows.forEach(row => {
                    const columns = row.querySelectorAll("td");
                    if (columns.length >= 5) {  // Ensure there are enough columns
                        const name = columns[0].innerText.trim();
                        const cost = parseFloat(columns[2].innerText.replace("€", "").trim()); // Remove € sign
                        const days = parseInt(columns[3].innerText.trim(), 10); // Convert to integer

                        if (!isNaN(cost) && !isNaN(days)) { // Ensure valid data
                            labels.push(name);
                            costs.push(cost);
                            totalDays.push(days);
                        }
                    }
                });

                // If no valid data, show a warning and prevent chart initialization
                if (labels.length === 0) {
                    console.warn("⚠ No valid data found for the chart.");
                    return;
                }

                // Create the chart
                window.procurementChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Menetlusaeg (päevad)",
                                data: totalDays.map(days => {
                                    const today = new Date();
                                    const submissionDate = new Date();
                                    submissionDate.setDate(today.getDate() + days);
                                    const timeDiff = submissionDate.getTime() - today.getTime();
                                    return Math.ceil(timeDiff / (1000 * 3600 * 24));
                                }),
                                backgroundColor: "rgba(153, 102, 255, 0.6)",
                                borderColor: "rgba(153, 102, 255, 1)",
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: true },
                            tooltip: { enabled: true }
                        }
                    }
                });
            }

            // Attach event listeners to navbar buttons
            document.addEventListener("DOMContentLoaded", function () {
                const navTool = document.getElementById("showForm");
                const navHanked = document.getElementById("showSavedSearches");
                const navHistory = document.getElementById("showHistory");
                const navSettings = document.getElementById("settingsButton");

                if (navTool) navTool.addEventListener("click", () => showTab('formContainer'));
                if (navHanked) navHanked.addEventListener("click", () => showTab('savedSearchesContainer'));
                if (navHistory) navHistory.addEventListener("click", () => showTab('historyContainer'));
                function showTab(tabId) {
                    closeAllTabs();
                    document.getElementById(tabId).classList.remove('hidden');
                }
                // Initialize Chart.js
                renderChart();
            });
            function toggleDashboard() {
                const dashboard = document.getElementById("dashboard");
                const recentCalculationsTable = document.getElementById("recentCalculationsTable");
                dashboard.classList.toggle("hidden");
                recentCalculationsTable.classList.toggle("hidden");
            }

            // Ensure the container fades in on page load
            document.addEventListener("DOMContentLoaded", () => {
                gsap.from("body", { opacity: 0, duration: 0.3 });
                updateTotalDuration(); // Ensure total duration is calculated and progress bars are updated on load
            });

            function updateProgressBars() {
                const stepData = extractStepDays();
                const totalDurationElement = document.getElementById('totalDuration');
                const totalDuration = parseInt(totalDurationElement?.innerText, 10) || 1; // Get total durationtotal duration

                stepData.forEach(step => {
                    const progressBar = document.getElementById(`progress-${step.index}`);
                    if (progressBar) {
                        // Hide the progress bar if "Ei kohaldu"
                        if (step.element.innerText.includes("Ei kohaldu")) {
                            progressBar.style.display = "none";
                            return;
                        } else {
                            progressBar.style.display = "block";
                        }

                        // Scale width dynamically based on the total duration
                        let progressWidth = (step.days / totalDuration) * 100 * 1.25;
                        progressBar.dataset.progress = progressWidth.toFixed(2);

                        // 🚀 FORCE width and color immediately before animation
                        progressBar.style.width = `${progressWidth}%`;

                        // Apply colors dynamically based on percentage of total duration
                        progressBar.classList.remove("bg-blue-500", "bg-green-500", "bg-yellow-500", "bg-red-500");
                        if (progressWidth >= 25) {
                            progressBar.classList.add("bg-red-500"); // Very long duration
                        } else if (progressWidth >= 14) {
                            progressBar.classList.add("bg-yellow-500"); // Medium duration
                        } else {
                            progressBar.classList.add("bg-green-500"); // Short duration
                        }
                        setTimeout(() => {
                            gsap.to(progressBar, { width: `${progressWidth}%`, duration: 0.8, ease: "power2.out" });
                        }, 10); // Small delay ensures colors are visible first
                    }
                });
            }

            function extractStepDays() {
                return Array.from(document.querySelectorAll('[id^="days-"]')).map((el, index) => {
                    let daysText = el.innerText;
                    let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);
                    return { index, element: el, days };
                });
            }

            function updateTotalDuration() {
                const totalDurationElement = document.getElementById('totalDuration');
                if (!totalDurationElement) return;

                const totalDays = extractStepDays().reduce((sum, step) => sum + step.days, 0);
                totalDurationElement.innerText = totalDays;

                updateProgressBars();
            }

            function adjustDays(index, adjustment) {
                const stepData = extractStepDays().find(step => step.index === index);
                if (!stepData) return;

                let newDays = Math.max(0, stepData.days + adjustment);
                stepData.element.innerText = `${newDays} päeva`;

                updateTotalDuration();
                updateProgressBars();

                // ✅ Kontrollime, kas hange on juba olemas
                let procurement = savedSearches.find(p => p.name === document.getElementById('name').value.trim());

                if (!procurement) {
                    procurement = new PublicProcurement(
                        document.getElementById('name').value.trim(),
                        parseFloat(document.getElementById('cost').value),
                        document.getElementById('procedureType').value,
                        document.getElementById('contractSigningDate').value
                    );
                }

                // ✅ Värskendame menetluse kestust ja taotluse esitamise kuupäeva
                procurement.procedureDuration = parseInt(document.getElementById('totalDuration').innerText);
                procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();
                document.getElementById('requestSubmissionDate').innerText = formatDate(procurement.requestSubmissionDate);
            }


            function initializeAdjustButtons() {
                document.querySelectorAll("button[data-adjust]").forEach(button => {
                    button.addEventListener("click", function () {
                        const index = parseInt(this.dataset.index, 10);
                        const adjustment = parseInt(this.dataset.adjust, 10);
                        adjustDays(index, adjustment);
                    });
                });
            }

            document.addEventListener("readystatechange", function () {
                if (document.readyState === "complete") {
                    console.log("Page fully loaded. Initializing scripts...");
                    initializeAdjustButtons();
                    updateTotalDuration();  // 🔥 Ensures total duration starts correctly
                    updateProgressBars();   // 🔥 Ensures progress bars scale correctly on load
                }

                async function registerUser(email, password) {
                    const { user } = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", user.uid), {
                        email: email,
                        role: "active",
                        approved: false
                    });
                }
            });

            //firestore salvstamine
            document.getElementById("saveToFirestore").addEventListener("click", async function () {
                if (savedSearches.length === 0) {
                    alert("Salvestatud otsinguid ei ole.");
                    return;
                }

                try {
                    const user = auth.currentUser;
                    if (!user) {
                        alert("Peate olema sisse logitud!");
                        return;
                    }

                    const userDocRef = doc(db, "users", user.uid);

                    // ✅ Laeme olemasolevad hankeandmed
                    const docSnap = await getDoc(userDocRef);
                    let existingData = docSnap.exists() ? docSnap.data().searches || [] : [];

                    // ✅ Lisame uued andmed olemasolevatele juurde
                    const updatedData = [...existingData, ...savedSearches];

                    // ✅ Salvestame uued andmed massiivi nimega `searches`
                    await setDoc(userDocRef, { searches: updatedData }, { merge: true });

                    console.log("✅ Hanked salvestatud Firestore'i ilma üle kirjutamata.");
                    showSuccessAlert("✅ Andmed salvestatud edukalt!");
                } catch (error) {
                    console.error("❌ Viga Firestore'i salvestamisel:", error);
                    showSuccessAlert("❌ Viga andmete salvestamisel!");
                }
            });

            //firestore laadimine
            document.getElementById('loadFromFirestore').addEventListener('click', async function () {
                const user = auth.currentUser;
                if (!user) {
                    alert("Andmete laadimiseks peab olema sisse logitud!");
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        console.error("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        return;
                    }

                    // ✅ Kontrollime, kas massiiv eksisteerib
                    let searches = userDoc.data().searches || userDoc.data().savedSearches || [];
                    console.log("📜 Laetud otsingud Firestore'ist:", searches);

                    // ✅ Kontrollime, kas see on massiiv
                    if (!Array.isArray(searches)) {
                        console.error("❌ Firestore'ist saadud 'searches' EI OLE massiiv! Vale struktuur:", searches);
                        return;
                    }

                    // ✅ Teisendame kuupäevad õigesse formaati
                    searches = searches.map(search => ({
                        ...search,
                        requestSubmissionDate: formatDate(search.requestSubmissionDate || "Määramata"),
                        contractSigningDate: formatDate(search.contractSigningDate || "Määramata")
                    }));

                    displaySearches(searches); // ✅ Uuendame tabeli
                } catch (error) {
                    console.error("❌ Otsingute laadimise viga Firestore'ist:", error);
                }
            });

            function displaySearches(searches) {
                const container = document.getElementById("savedSearchesTableBody");
                if (!container) {
                    console.error("❌ Ei leitud tabeli keha: savedSearchesTableBody");
                    return;
                }

                console.log("🔎 Kuvan otsingud tabelisse, kokku:", searches.length, "otsingut");
                container.innerHTML = ""; // ✅ Puhastame tabeli enne lisamist

                if (searches.length === 0) {
                    container.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">⚠ Ei leitud salvestatud hankeid.</td></tr>`;
                    return;
                }

                searches.forEach((search, index) => {
                    console.log(`📌 Kuvan otsingu [${index}]:`, search);
                    container.innerHTML += `
            <tr class="border-b even:bg-gray-100 hover:bg-gray-200 transition-all">
                <td class="p-4">${search.name}</td>
                <td class="p-4">${search.procedureType}</td>
                <td class="p-4">${search.cost} €</td>
                <td class="p-4 text-blue-600 font-semibold">${search.requestSubmissionDate}</td>
                <td class="p-4 text-gray-500">${search.contractSigningDate}</td>
                <td class="p-4 text-center">
                    <button onclick="editSearch(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105">✏️ Muuda</button>
                </td>
                <td class="p-4 text-center">
                    <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">❌ Kustuta</button>
                </td>
            </tr>
        `;
                });

                console.log("✅ Otsingud lisatud tabelisse!");
            }
        </script>

        <style>
            /* Navbar button hover effect */
            .nav-button {
                transition: background-color 0.3s ease, transform 0.2s ease;
            }

            .nav-button:hover {
                background-color: rgba(233, 253, 254, 0.2);
                transform: scale(1.05);
            }

            /* Navbar styling */
            .navbar {
                position: fixed;
                top: 0;
                z-index: 50;
                box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
                padding: 1rem;
            }

            /* Ensure the clock is fixed in the corner */
            #currentDateTime {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                z-index: 1000;
            }

            /* Navbar Links */
            .nav-link {
                padding-bottom: 4px;
                transition: all 0.3s ease;
            }

            .nav-link:hover {
                opacity: 0.8;
            }

            .active-tab {
                border-bottom-width: 2px;
                border-color: white;
            }

            /* ✅ Fade-out efekt rea eemaldamiseks */
            .fade-out {
                opacity: 0;
                transition: opacity 0.5s ease-out;
            }

            /* ✅ Modaalakna stiil */
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
        <script>
            // Active Tab Highlighting
            document.addEventListener('DOMContentLoaded', function () {
                const navLinks = document.querySelectorAll('.nav-link');

                function setActiveTab(event) {
                    navLinks.forEach(link => link.classList.remove('border-b-2', 'border-white'));
                    event.target.classList.add('border-b-2', 'border-white');
                }

                navLinks.forEach(link => {
                    link.addEventListener('click', setActiveTab);
                });
            });

            //menetlusliigi nimi
            document.addEventListener("DOMContentLoaded", function () {
                const procedureSelect = document.getElementById("procedureType");
                const procedureLabel = document.getElementById("procedureLabel");

                function updateProcedureLabel() {
                    const selectedOption = procedureSelect.options[procedureSelect.selectedIndex];
                    const optgroup = selectedOption.closest("optgroup"); // Find parent optgroup

                    if (optgroup) {
                        procedureLabel.innerText = `${optgroup.label}`;

                        // Animate fade-in effect
                        gsap.to(procedureLabel, { opacity: 1, y: 5, duration: 0.5, ease: "power2.out" });
                    } else {
                        gsap.to(procedureLabel, { opacity: 0, duration: 0.3 });
                    }
                }

                // Update on selection change
                procedureSelect.addEventListener("change", updateProcedureLabel);

                // Run once on page load to show the initially selected value
                updateProcedureLabel();
            });

            document.addEventListener("DOMContentLoaded", function () {
                function animateProgressBars() {
                    document.querySelectorAll(".progress-bar").forEach(bar => {
                        gsap.to(bar, { width: bar.dataset.progress + "%", duration: 1.5, ease: "power2.out" });
                    });
                }

                function extractStepDays() {
                    return Array.from(document.querySelectorAll('[id^="days-"]')).map((el, index) => {
                        let daysText = el.innerText;
                        let days = parseInt(daysText.match(/\d+/)?.[0] || "0", 10);
                        return { index, element: el, days };
                    });
                }
                function updateTotalDuration() {
                    const totalDurationElement = document.getElementById('totalDuration');
                    if (!totalDurationElement) return;

                    const totalDays = extractStepDays().reduce((sum, step) => sum + step.days, 0);
                    totalDurationElement.innerText = totalDays;

                    updateProgressBars();
                }

                function adjustDays(index, adjustment) {
                    const stepData = extractStepDays().find(step => step.index === index);
                    if (!stepData) return;

                    let newDays = Math.max(0, stepData.days + adjustment);
                    stepData.element.innerText = `${newDays} päeva`;

                    updateTotalDuration(); // Update total duration
                    updateProgressBars();  // Update progress bars dynamically
                }

                function initializeAdjustButtons() {
                    document.querySelectorAll("button[data-adjust]").forEach(button => {
                        button.addEventListener("click", function () {
                            const index = parseInt(this.dataset.index, 10);
                            const adjustment = parseInt(this.dataset.adjust, 10);
                            adjustDays(index, adjustment);
                        });
                    });
                }

                document.addEventListener("readystatechange", function () {
                    if (document.readyState === "complete") {
                        console.log("Page fully loaded. Initializing scripts...");
                        initializeAdjustButtons();
                        updateTotalDuration();  // 🔥 Ensures total duration starts correctly
                        updateProgressBars();   // 🔥 Ensures progress bars scale correctly on load
                        setTimeout(updateProgressBars, 500); // 🔥 Second pass to ensure visibility
                    }
                });
            });
        </script>

        <script>
            function showSuccessAlert(message) {
                const alertBox = document.getElementById("successAlert");
                const alertText = document.getElementById("alertMessage");

                alertText.innerText = message;
                alertBox.classList.remove("hidden", "opacity-0", "scale-95");
                alertBox.classList.add("opacity-100", "scale-100");

                // Peida teade 3 sekundi pärast
                setTimeout(() => {
                    alertBox.classList.add("opacity-0", "scale-95");
                    setTimeout(() => alertBox.classList.add("hidden"), 300);
                }, 3000);
            }
        </script>

        <!-- Firebase Authentication Logic (Add before closing body tag) -->
        <script type="module">
            import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
            import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

            // ✅ Firebase initsialiseerimine
            const auth = getAuth();
            const db = getFirestore();

            document.addEventListener("DOMContentLoaded", () => {
                console.log("🚀 Page Loaded - Waiting for login or guest selection.");

                // ✅ Buttons
                const loginButton = document.getElementById("loginButton");
                const registerButton = document.getElementById("registerButton");
                const guestButton = document.getElementById("guestButton");
                const logoutButton = document.getElementById("logoutButton");
                const settingsButton = document.getElementById("settingsButton");
                const showHankedButton = document.getElementById("showSavedSearches");

                // ✅ Sections
                const hankedSection = document.getElementById("savedSearchesContainer");
                const settingsSection = document.getElementById("settingsContainer");
                const adminTab = document.getElementById("adminTab");

                // 🔥 Peidame "Hanked" ja "Seaded" esialgu
                hankedSection?.classList.add("hidden");
                settingsSection?.classList.add("hidden");

                // ✅ "Hanked" nupp laadib andmed Firestore'ist ja kuvab need
                showHankedButton?.addEventListener("click", async () => {
                    console.log("📂 'Hanked' nuppu vajutati, laen Firestore andmed...");
                    await loadUserSearches();
                    // ✅ Uuendame ka lokaalseid hankeid tabelis
                    updateSavedSearchesTable();
                    hankedSection?.classList.remove("hidden");
                });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("✅ Kasutaja sisse logitud:", user.email);

                        // ✅ Eemaldame hidden klassi, et kuvada menüünupud
                        showHankedButton?.classList.remove("hidden");
                        settingsButton?.classList.remove("hidden");

                        // ✅ Peidame sisselogimisnupud ja kuvame "Logi välja" nupu
                        loginButton?.classList.add("hidden");
                        registerButton?.classList.add("hidden");
                        guestButton?.classList.add("hidden");
                        logoutButton?.classList.remove("hidden");

                        // ✅ Kontrollime Firestore rolli
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            console.log("📜 Firestore roll:", userData.role);

                            if (userData.role === "admin") {
                                adminTab?.classList.remove("hidden");
                            } else {
                                adminTab?.classList.add("hidden");
                            }
                        }
                    } else {
                        console.log("🚫 Kasutaja pole sisse logitud.");

                        // ✅ Peidame "Hanked", "Seaded" ja "Admin" vahelehed
                        showHankedButton?.classList.add("hidden");
                        settingsButton?.classList.add("hidden");
                        adminTab?.classList.add("hidden");

                        // ✅ Kuvame sisselogimisnupud ja peidame "Logi välja" nupu
                        loginButton?.classList.remove("hidden");
                        registerButton?.classList.remove("hidden");
                        guestButton?.classList.remove("hidden");
                        logoutButton?.classList.add("hidden");
                    }
                });

                // 🔥 Logout Button Click Event
                logoutButton?.addEventListener("click", async () => {
                    console.log("🔴 Logging out user...");
                    await signOut(auth);
                    window.location.href = "index.html";
                });

                // ✅ Funktsioon otsingu salvestamiseks Firestore'i
                const saveSearchToFirestore = async (searchData) => {
                    const user = auth.currentUser;
                    if (!user) {
                        showNotification("Andmete salvestamiseks peab olema sisse logitud!", 3000);
                        return;
                    }

                    try {
                        await updateDoc(doc(db, "users", user.uid), {
                            searches: arrayUnion(searchData)
                        });
                        showNotification("✅ Otsing salvestatud Firestore'i!", 3000);
                        console.log("✅ Otsing salvestatud Firestore'i:", searchData);
                    } catch (error) {
                        showNotification("❌ Otsingu salvestamise viga!", 3000);
                        console.error("❌ Otsingu salvestamise viga:", error);
                    }
                };

                // ✅ Seome otsingu salvestamise "lisa hange tabelisse" nupuga
                document.getElementById('procurementForm').addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const name = document.getElementById('name').value;
                    const cost = parseFloat(document.getElementById('cost').value);
                    const procedureType = document.getElementById('procedureType').value;
                    const contractSigningDate = document.getElementById('contractSigningDate').value;

                    const procurement = new PublicProcurement(name, cost, procedureType, contractSigningDate);
                    procurement.requestSubmissionDate = procurement.calculateRequestSubmissionDate();

                    // ✅ Värskendame tulemuste kuvamist, kuid EI LISATA HANKED TABELISSE
                    document.getElementById('result').innerHTML = procurement.generateHTML();

                    // ✅ Progressi ja kestuse uuendamine
                    setTimeout(() => {
                        updateTotalDuration();
                        updateProgressBars();
                    }, 100);

                    // ✅ Kuvame tulemuste konteineri
                    document.getElementById('resultContainer').classList.remove('hidden');

                    console.log("✅ Menetlusaeg arvutatud, kuid hange EI LISATUD tabelisse.");
                });
                async function loadUserSearches() {
                    const user = auth.currentUser;
                    if (!user) {
                        console.error("❌ Kasutajat ei leitud, ei saa otsinguid laadida.");
                        return;
                    }

                    try {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            let searches = userDoc.data().searches || [];
                            console.log("📜 Laetud otsingud Firestore'ist:", searches);

                            // ✅ Kontrollime ja teisendame kuupäevad õigesse formaati
                            searches = searches.map((search, index) => {
                                if (!search.requestSubmissionDate || search.requestSubmissionDate === "Määramata") {
                                    console.warn(`⚠ Otsingul [${index}] puudub requestSubmissionDate, määrame uue.`);
                                    search.requestSubmissionDate = "Määramata";
                                } else if (search.requestSubmissionDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                    // Kui kuupäev on "YYYY-MM-DD", teisendame selle "dd.mm.yyyy"
                                    const [year, month, day] = search.requestSubmissionDate.split("-");
                                    search.requestSubmissionDate = `${day}.${month}.${year}`;
                                }
                                return search;
                            });

                            displaySearches(searches);
                        } else {
                            console.log("❌ Kasutaja dokumenti ei leitud Firestore'ist.");
                        }
                    } catch (error) {
                        console.error("❌ Otsingute laadimise viga:", error);
                    }
                }
                const deleteSearch = async (index) => {
                    const user = auth.currentUser;
                    if (!user) {
                        alert("Kustutamiseks peab olema sisse logitud!");
                        return;
                    }

                    try {
                        const userDocRef = doc(db, "users", user.uid);
                        const userDoc = await getDoc(userDocRef);

                        if (userDoc.exists()) {
                            let searches = userDoc.data().searches || [];

                            if (index < 0 || index >= searches.length) {
                                console.error("❌ Kehtetu indeks:", index);
                                return;
                            }

                            const searchToDelete = searches[index];

                            // 🔍 Kontrollime, milline element kustutatakse
                            console.log("🔴 Enne kustutamist:", searches);
                            console.log("🚨 Kustutame:", searchToDelete);

                            // 🔥 Kustutame Firestore'ist ainult selle konkreetse objekti
                            await updateDoc(userDocRef, {
                                searches: arrayRemove(searchToDelete),
                            });

                            console.log("✅ Otsing kustutatud Firestore'ist:", searchToDelete);

                            // 🔄 Laadime uuesti andmed, et värskendada tabelit
                            await loadUserSearches();
                        }
                    } catch (error) {
                        console.error("❌ Firestore'i kustutamise viga:", error);
                    }
                };

                // ✅ Funktsioon otsingute kuvamiseks tabelis
                function displaySearches(searches) {
                    const container = document.getElementById("savedSearchesTableBody");
                    if (!container) {
                        console.error("❌ Ei leitud tabeli keha: savedSearchesTableBody");
                        return;
                    }

                    console.log("🔎 Kuvan otsingud tabelisse:", searches);
                    container.innerHTML = ""; // ✅ Puhastame tabeli enne lisamist

                    if (searches.length === 0) {
                        container.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">⚠ Ei leitud salvestatud hankeid.</td></tr>`;
                        return;
                    }

                    searches.forEach((search, index) => {
                        container.innerHTML += `
                                <tr class="border-b even:bg-gray-100 hover:bg-gray-200 transition-all">
                                    <td class="p-4">${search.name}</td>
                                    <td class="p-4">${search.procedureType}</td>
                                    <td class="p-4">${search.cost} €</td>
                                    <td class="p-4 text-blue-600 font-semibold">${search.requestSubmissionDate}</td>
                                    <td class="p-4 text-gray-500">${search.contractSigningDate}</td>
                                    <td class="p-4 text-center">
                                        <button onclick="editSearch(${index})" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition transform hover:scale-105">✏️ Muuda</button>
                                    </td>
                                    <td class="p-4 text-center">
                                        <button onclick="deleteSearch(${index})" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition transform hover:scale-105">❌ Kustuta</button>
                                    </td>
                                </tr>
                            `;
                    });

                    console.log("✅ Otsingud lisatud tabelisse!");
                };
            });
        </script>
</body>
<button class="btn btn-primary">Testi nupp</button>

</html>